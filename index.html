<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기가지현</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 110px; }
        .calendar-day.other-month { background-color: #f9fafb; color: #d1d5db; }
        @keyframes pulse { 50% { opacity: .5; } }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #e5e7eb; border-radius: 0.5rem; }
        .sidebar { transition: width 0.3s ease-in-out, transform 0.3s ease-in-out; }
        
        .btn-sky { background-color: #0ea5e9; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: background-color 0.2s; }
        .btn-sky:hover { background-color: #0284c7; }
        .btn-rose { background-color: #f43f5e; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: background-color 0.2s; }
        .btn-rose:hover { background-color: #e11d48; }
        .btn-green { background-color: #22c55e; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: background-color 0.2s; }
        .btn-green:hover { background-color: #16a34a; }
        .btn-gray { background-color: #e5e7eb; color: #374151; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: background-color 0.2s; }
        .btn-gray:hover { background-color: #d1d5db; }
        .btn-red { background-color: #f43f5e; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: background-color 0.2s; }
        .btn-red:hover { background-color: #e11d48; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- 상수 및 Firebase 초기화 ---
        const CONSTANTS = {
            SCHOOL_DOMAIN: 'somyong.ms.kr',
            COLLECTIONS: { TEACHERS: 'teachers', STUDENTS: 'students', CLASSES: 'classes', SCORES: 'scores', SCHEDULES: 'schedules', ASSESSMENTS: 'assessments' },
        };

        const firebaseConfig = {
            apiKey: "AIzaSyBXWQs6WSQeno57qZOMyRUWGFsLwG9M7ws",
            authDomain: "gigajihyun.firebaseapp.com",
            projectId: "gigajihyun",
            storageBucket: "gigajihyun.appspot.com",
            messagingSenderId: "28213778220",
            appId: "1:28213778220:web:08c3b3fcd8187a57377e89",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        // --- 유틸리티 함수 ---
        const mapAuthCodeToMessage = (code) => {
            switch (code) {
                case 'auth/user-not-found': return '등록되지 않은 사용자입니다.';
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                case 'auth/invalid-login-credentials':
                    return '아이디 또는 비밀번호가 올바르지 않습니다.';
                case 'auth/email-already-in-use': return '이미 사용 중인 계정입니다.';
                case 'permission-denied': return '권한이 없습니다. 관리자에게 문의하세요.';
                default: return `오류가 발생했습니다: ${code}`;
            }
        };

        // --- 공용 컴포넌트 ---
        const Modal = ({ modalState, setModalState }) => {
            const { isOpen, title, content, isConfirm, onConfirm, confirmText = '확인', cancelText = '취소', size = 'max-w-lg' } = modalState;
            if (!isOpen) return null;
            
            const handleClose = () => setModalState({ isOpen: false });
            
            const handleConfirm = async () => {
                if (onConfirm) {
                    const result = await onConfirm();
                    if (result === false) return;
                }
                handleClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100]" onClick={handleClose}>
                    <div className={`bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full m-4 ${size}`} onClick={e => e.stopPropagation()}>
                        {title && <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">{title}</h3>}
                        <div className="text-gray-600">{content}</div>
                        <div className={`flex gap-4 mt-6 ${isConfirm ? 'justify-end' : 'justify-center'}`}>
                            {isConfirm && (<button onClick={handleClose} className="btn-gray">{cancelText}</button>)}
                            <button onClick={handleConfirm} className="btn-sky">{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- 일정 관리 관련 컴포넌트 ---
        const ScheduleCalendar = ({ classes, selectedClass, selectedClassId, students, allSchoolStudents, teacherId, isTeacher, setModalState: setAppModalState }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [schedules, setSchedules] = useState([]);
            const [modalState, setModalState] = useState({ formOpen: false, detailOpen: false, initialData: null });
            const [classNotice, setClassNotice] = useState('');

            useEffect(() => {
                if (selectedClass) {
                    setClassNotice(selectedClass.classNotice || '');
                }
            }, [selectedClass]);

            useEffect(() => {
                if (!selectedClassId) return;
                const unsubscribe = db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(selectedClassId).onSnapshot(doc => {
                    setSchedules(doc.exists ? doc.data().events || [] : []);
                });
                return () => unsubscribe();
            }, [selectedClassId]);
            
            const handleNoticeSave = async () => {
                if (!selectedClassId) return;
                try {
                    await db.collection('classes').doc(selectedClassId).update({
                        classNotice: classNotice
                    });
                    setAppModalState({isOpen: true, title: "성공", content: "공지사항이 저장되었습니다."});
                } catch (error) {
                    console.error("공지사항 저장 실패:", error);
                    setAppModalState({isOpen: true, title: "오류", content: "공지사항 저장에 실패했습니다."});
                }
            };

            const startDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

            const handleAddClick = (dateStr) => {
                if (isTeacher) setModalState({ formOpen: true, detailOpen: false, initialData: { date: dateStr, relatedStudents: [] } });
            };
            const handleEditClick = (schedule) => setModalState({ formOpen: true, detailOpen: false, initialData: schedule });
            const handleScheduleClick = (schedule) => setModalState({ formOpen: false, detailOpen: true, initialData: schedule });
            
            const handleFormSubmit = async (scheduleData) => {
                const { id, ...restData } = scheduleData;
                const scheduleId = id || `sched_${Date.now()}`;
                const newSchedulePayload = { 
                    ...restData, 
                    id: scheduleId, 
                    relatedStudents: scheduleData.relatedStudents.map(s => ({id: s.id, name: s.name, studentId: s.studentId})), 
                    authorId: teacherId 
                };

                const classIdsToUpdate = scheduleData.applyToAll ? classes.map(c => c.id) : [selectedClassId];
                
                const batch = db.batch();

                const scheduleDocs = await Promise.all(
                    classIdsToUpdate.map(id => db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(id).get())
                );

                scheduleDocs.forEach((doc, index) => {
                    const classId = classIdsToUpdate[index];
                    const classScheduleRef = db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(classId);
                    
                    const existingEvents = doc.exists ? doc.data().events || [] : [];
                    let newEvents;

                    if (id) {
                        const eventIndex = existingEvents.findIndex(event => event.id === id);
                        if (eventIndex > -1) {
                            existingEvents[eventIndex] = newSchedulePayload;
                            newEvents = existingEvents;
                        } else {
                            newEvents = [...existingEvents, newSchedulePayload];
                        }
                    } else {
                        newEvents = [...existingEvents, newSchedulePayload];
                    }
                    
                    batch.set(classScheduleRef, { events: newEvents }, { merge: true });
                });

                try {
                    await batch.commit();
                } catch (error) {
                    console.error("일정 저장 실패:", error);
                    setAppModalState({ isOpen: true, title: "오류", content: `일정 저장에 실패했습니다. Firestore 보안 규칙을 확인해주세요.` });
                }
            };

            const handleDeleteRequest = (scheduleToDelete) => {
                const confirmContent = scheduleToDelete.applyToAll
                    ? `'${scheduleToDelete.title}' 일정을 나의 모든 학급에서 삭제합니다. 정말 삭제하시겠습니까?`
                    : `'${scheduleToDelete.title}' 일정을 정말 삭제하시겠습니까?`;

                setAppModalState({
                    isOpen: true,
                    title: "삭제 확인",
                    content: confirmContent,
                    isConfirm: true,
                    onConfirm: () => handleDeleteSchedule(scheduleToDelete)
                });
            };

            const handleDeleteSchedule = async (scheduleToDelete) => {
                const classIdsToUpdate = scheduleToDelete.applyToAll ? classes.map(c => c.id) : [selectedClassId];
                
                const batch = db.batch();

                const scheduleDocs = await Promise.all(
                    classIdsToUpdate.map(id => db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(id).get())
                );

                scheduleDocs.forEach((doc, index) => {
                    if (doc.exists) {
                        const classId = classIdsToUpdate[index];
                        const docRef = db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(classId);
                        const existingEvents = doc.data().events || [];
                        const newEvents = existingEvents.filter(event => event.id !== scheduleToDelete.id);
                        batch.update(docRef, { events: newEvents });
                    }
                });

                try {
                    await batch.commit();
                } catch (error) {
                    console.error("일정 삭제 실패:", error);
                    setAppModalState({ isOpen: true, title: "오류", content: "일정 삭제 중 오류가 발생했습니다." });
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    {isTeacher && <ScheduleFormModal isOpen={modalState.formOpen} onClose={() => setModalState({ formOpen: false, detailOpen: false, initialData: null })} onSubmit={handleFormSubmit} initialData={modalState.initialData} currentClassStudents={students} allSchoolStudents={allSchoolStudents} setModalState={setAppModalState} />}
                    <ScheduleDetailModal isOpen={modalState.detailOpen} onClose={() => setModalState({ formOpen: false, detailOpen: false, initialData: null })} schedule={modalState.initialData} onEdit={handleEditClick} onDelete={handleDeleteRequest} isTeacher={isTeacher}/>
                    
                    <div className="mb-4">
                        {isTeacher ? (
                            <div className="flex items-center gap-2">
                                <input 
                                    type="text"
                                    value={classNotice}
                                    onChange={(e) => setClassNotice(e.target.value)}
                                    placeholder="학급 공지사항을 입력하세요..."
                                    className="w-full p-2 border rounded-md"
                                />
                                <button onClick={handleNoticeSave} className="btn-sky !px-4 !py-2 flex-shrink-0">저장</button>
                            </div>
                        ) : (
                            <div className="p-3 bg-sky-50 text-sky-800 rounded-md text-center">
                                <p>{selectedClass?.classNotice || '등록된 공지사항이 없습니다.'}</p>
                            </div>
                        )}
                    </div>

                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                           <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 className="text-2xl font-bold">{currentDate.getFullYear()}년 {currentDate.getMonth() + 1}월</h3>
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                           <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div className="calendar-grid border-t border-l">
                        {['일', '월', '화', '수', '목', '금', '토'].map(day => <div key={day} className="text-center font-bold p-3 bg-gray-50 border-b border-r">{day}</div>)}
                        {Array.from({ length: startDay }).map((_, i) => <div key={`empty-${i}`} className="calendar-day border-b border-r other-month"></div>)}
                        {Array.from({ length: daysInMonth }).map((_, i) => {
                            const day = i + 1;
                            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const daySchedules = schedules.filter(s => s.date === dateStr);
                            const dayOfWeek = date.getDay();

                            return (
                                <div key={day} className={`calendar-day border-b border-r p-2 flex flex-col ${isTeacher ? 'cursor-pointer hover:bg-sky-50' : ''} transition-colors duration-200`} onClick={() => handleAddClick(dateStr)}>
                                    <span className={`font-bold ${dayOfWeek === 0 ? 'text-red-500' : ''} ${dayOfWeek === 6 ? 'text-blue-500' : ''}`}>{day}</span>
                                    <div className="flex-grow mt-1 space-y-1 overflow-y-auto">
                                    {daySchedules.map((s) => (
                                        <div key={s.id} onClick={(e) => { e.stopPropagation(); handleScheduleClick(s);}} className="bg-sky-100 text-sky-800 text-xs p-1 rounded-md hover:bg-sky-200 cursor-pointer">
                                            <p className="font-bold truncate">{s.title}</p>
                                        </div>
                                    ))}
                                    </div>
                                </div>
                            );
                        })}
                        {Array.from({ length: (7 - (daysInMonth + startDay) % 7) % 7 }).map((_, i) => <div key={`empty-end-${i}`} className="calendar-day border-b border-r other-month"></div>)}
                    </div>
                </div>
            );
        };
        
        // --- 교사 메뉴 컴포넌트들 ---
        const EditClassModal = ({ isOpen, onClose, classItem, onSave }) => {
            if (!isOpen) return null;

            const [className, setClassName] = useState(classItem.className);

            const handleSave = async () => {
                if (!className.trim()) {
                    alert('학급 이름은 비워둘 수 없습니다.');
                    return;
                }
                await onSave(classItem.id, { className });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">학급 이름 수정</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">학급 이름</label>
                                <input type="text" value={className} onChange={e => setClassName(e.target.value)} className="w-full mt-1 p-2 border rounded-md" />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">학급 코드 (변경 불가)</label>
                                <input type="text" value={classItem.classCode} disabled className="w-full mt-1 p-2 border rounded-md bg-gray-100" />
                            </div>
                        </div>
                        <div className="flex gap-4 mt-8 justify-end">
                            <button onClick={onClose} className="btn-gray">취소</button>
                            <button onClick={handleSave} className="btn-sky">저장</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ClassManagement = ({ teacherId, classes, setModalState, onUpdateClass, onDeleteClass }) => {
            const [className, setClassName] = useState('');
            const [classCode, setClassCode] = useState('');
            const [editingClass, setEditingClass] = useState(null);

            const handleAddClass = async (e) => {
                e.preventDefault();
                if (!className.trim() || classCode.length !== 6) { setModalState({ isOpen: true, title: '입력 오류', content: '학급명과 6자리 학급코드를 모두 올바르게 입력해주세요.' }); return; }
                const codeExistsQuery = db.collection(CONSTANTS.COLLECTIONS.CLASSES).where('classCode', '==', classCode);
                const codeExistsSnapshot = await codeExistsQuery.get();
                if (!codeExistsSnapshot.empty) { setModalState({ isOpen: true, title: '오류', content: '이미 사용 중인 학급 코드입니다.' }); return; }
                await db.collection(CONSTANTS.COLLECTIONS.CLASSES).add({ teacherId, className, classCode });
                setModalState({ isOpen: true, title: '성공', content: '새로운 학급이 생성되었습니다.' });
                setClassName(''); setClassCode('');
            };
            
            const handleEditClick = (classItem) => {
                setEditingClass(classItem);
            };

            const handleDeleteClick = (classItem) => {
                setModalState({
                    isOpen: true, isConfirm: true, title: '학급 삭제 확인',
                    content: `'${classItem.className}' 학급을 정말로 삭제하시겠습니까? 학급에 속한 모든 학생 정보, 점수, 일정이 함께 삭제되며 복구할 수 없습니다.`,
                    confirmText: '삭제',
                    onConfirm: () => onDeleteClass(classItem.id)
                });
            };

            const handleClassCodeChange = (value) => {
                const upperValue = value.toUpperCase();
                let filteredValue = '';
                if (upperValue.length > 0) {
                    const firstChar = upperValue.substring(0, 1).replace(/[^A-Z]/g, '');
                    const restChars = upperValue.substring(1).replace(/[^A-Z0-9]/g, '');
                    filteredValue = firstChar + restChars;
                }
                setClassCode(filteredValue);
            };
            
            return (
                <div>
                    {editingClass && (
                        <EditClassModal
                            isOpen={!!editingClass}
                            onClose={() => setEditingClass(null)}
                            classItem={editingClass}
                            onSave={onUpdateClass}
                        />
                    )}
                    <h2 className="text-3xl font-bold mb-6 text-gray-800">학급 관리</h2>
                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-bold mb-4">새 학급 추가</h3>
                        <form onSubmit={handleAddClass} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full"><label className="text-sm font-medium text-gray-600">학급명</label><input type="text" value={className} onChange={e => setClassName(e.target.value)} placeholder="예: 1학년 1반" className="w-full mt-1 p-2 border rounded-md" /></div>
                            <div className="flex-1 w-full"><label className="text-sm font-medium text-gray-600">학급 코드 (6자리, 첫 글자는 영문)</label><input type="text" value={classCode} onChange={e => handleClassCodeChange(e.target.value)} maxLength={6} placeholder="예: A12345" className="w-full mt-1 p-2 border rounded-md" /></div>
                            <button type="submit" className="btn-sky w-full md:w-auto !px-6 !py-2">추가</button>
                        </form>
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                       <h3 className="text-xl font-bold mb-4">내 학급 목록</h3>
                        <div className="space-y-2">
                            {classes.map(c => (
                                <div key={c.id} className="p-3 bg-gray-50 rounded-md flex justify-between items-center">
                                    <div>
                                        <span>{c.className}</span>
                                        <span className="ml-4 font-mono bg-gray-200 px-2 py-1 rounded text-sm">{c.classCode}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => handleEditClick(c)} className="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-md">수정</button>
                                        <button onClick={() => handleDeleteClick(c)} className="bg-red-100 hover:bg-red-200 text-red-700 text-xs font-bold py-1 px-3 rounded-md">삭제</button>
                                    </div>
                                </div>
                            ))}
                            {classes.length === 0 && <p className="text-gray-500 text-center py-4">생성된 학급이 없습니다.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const InviteStudentModal = ({ isOpen, onClose, student, classes, onInvite }) => {
            const [targetClassId, setTargetClassId] = useState('');

            useEffect(() => {
                if (isOpen) {
                    const availableClasses = classes.filter(c => !student.classIds.includes(c.id));
                    if (availableClasses.length > 0) {
                        setTargetClassId(availableClasses[0].id);
                    } else {
                        setTargetClassId('');
                    }
                }
            }, [isOpen, classes, student]);

            if (!isOpen) return null;

            const handleInvite = () => {
                if (targetClassId) {
                    onInvite(student, targetClassId);
                    onClose();
                }
            };

            const availableClasses = classes.filter(c => !student.classIds.includes(c.id));

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100]" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">학급 초대</h3>
                        <p className="text-center mb-6">
                            <span className="font-bold">{student.name}({student.studentId})</span> 학생을 어느 학급으로 초대하시겠습니까?
                        </p>
                        {availableClasses.length > 0 ? (
                            <div className="space-y-4">
                                <select value={targetClassId} onChange={e => setTargetClassId(e.target.value)} className="w-full p-2 border rounded-md">
                                    {availableClasses.map(c => (
                                        <option key={c.id} value={c.id}>{c.className}</option>
                                    ))}
                                </select>
                                <div className="flex gap-4 mt-8 justify-end">
                                    <button onClick={onClose} className="btn-gray">취소</button>
                                    <button onClick={handleInvite} className="btn-green">초대하기</button>
                                </div>
                            </div>
                        ) : (
                            <p className="text-center text-gray-500 py-4">초대할 수 있는 다른 학급이 없습니다.</p>
                        )}
                    </div>
                </div>
            );
        };
        
        const StudentManagement = ({ students, pendingStudents, deleteStudent, approveStudent, rejectStudent, inviteStudent, classes }) => {
            const [invitingStudent, setInvitingStudent] = useState(null);

            return (
                <div>
                    {invitingStudent && (
                        <InviteStudentModal 
                            isOpen={!!invitingStudent}
                            onClose={() => setInvitingStudent(null)}
                            student={invitingStudent}
                            classes={classes}
                            onInvite={inviteStudent}
                        />
                    )}

                    <h2 className="text-3xl font-bold mb-6 text-gray-800">학생 관리</h2>
                    
                    {pendingStudents.length > 0 && (
                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-xl font-bold mb-4">가입 승인 대기</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left min-w-[600px]">
                                    <thead className="bg-gray-50"><tr><th className="p-3">이름</th><th className="p-3">학번</th><th className="p-3">학교 계정</th><th className="p-3 text-center">작업</th></tr></thead>
                                    <tbody>
                                        {pendingStudents.map(s => ( 
                                            <tr key={s.id} className="border-b">
                                                <td className="p-3">{s.name}</td>
                                                <td className="p-3">{s.studentId}</td>
                                                <td className="p-3">{s.schoolAccount}</td>
                                                <td className="p-3 text-center flex gap-2 justify-center">
                                                    <button onClick={() => rejectStudent(s.id)} className="btn-red !px-4 !py-1">거절</button>
                                                    <button onClick={() => approveStudent(s.id)} className="btn-sky !px-4 !py-1">승인</button>
                                                </td>
                                            </tr> 
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h3 className="text-xl font-bold mb-4">학급 학생 목록</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left min-w-[600px]">
                                <thead className="bg-gray-50"><tr><th className="p-3">이름</th><th className="p-3">학번</th><th className="p-3">학교 계정</th><th className="p-3 text-center">작업</th></tr></thead>
                                <tbody>
                                    {students.map(s => ( 
                                        <tr key={s.id} className="border-b">
                                            <td className="p-3">{s.name}</td>
                                            <td className="p-3">{s.studentId}</td>
                                            <td className="p-3">{s.schoolAccount}</td>
                                            <td className="p-3 text-center flex gap-2 justify-center">
                                                <button onClick={() => setInvitingStudent(s)} className="btn-green !px-3 !py-1 text-xs">학급 초대</button>
                                                <button onClick={() => deleteStudent(s)} className="btn-red !px-3 !py-1 text-xs">학급에서 제외</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {students.length === 0 && <p className="text-center text-gray-500 py-8">소속된 학생이 없습니다.</p>}
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- 학생 메뉴 컴포넌트 ---
        const StudentInfo = ({ user, userData, setModalState, refreshUserData }) => {
            const [newPassword, setNewPassword] = useState('');
            const [classCode, setClassCode] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleChangePassword = async () => {
                if (!/^\d{6,}$/.test(newPassword)) {
                    setModalState({ isOpen: true, title: '입력 오류', content: '비밀번호는 숫자 6자리 이상이어야 합니다.' });
                    return;
                }
                setIsLoading(true);
                try {
                    await auth.currentUser.updatePassword(newPassword);
                    setModalState({ isOpen: true, title: '성공', content: '비밀번호가 변경되었습니다.' });
                    setNewPassword('');
                } catch (e) {
                    setModalState({ isOpen: true, title: '오류', content: '비밀번호 변경에 실패했습니다. 다시 로그인 후 시도하세요.' });
                }
                setIsLoading(false);
            };

            const handleJoinClass = async () => {
                if (classCode.length !== 6) {
                    setModalState({ isOpen: true, title: '입력 오류', content: '학급 코드는 6자리여야 합니다.' });
                    return;
                }
                setIsLoading(true);
                try {
                    const classSnap = await db.collection('classes').where('classCode', '==', classCode.toUpperCase()).get();
                    if (classSnap.empty) {
                        setModalState({ isOpen: true, title: '오류', content: '존재하지 않는 학급 코드입니다.' });
                        setIsLoading(false); return;
                    }
                    const classId = classSnap.docs[0].id;
                    if (userData.classIds?.includes(classId)) {
                        setModalState({ isOpen: true, title: '오류', content: '이미 가입 신청했거나 소속된 학급입니다.' });
                        setIsLoading(false); return;
                    }
                    await db.collection('students').doc(user.uid).update({
                        classIds: FieldValue.arrayUnion(classId),
                        [`approvedBy.${classId}`]: false
                    });
                    setModalState({ isOpen: true, title: '성공', content: '가입 요청이 전송되었습니다. 교사의 승인을 기다려주세요.' });
                    setClassCode('');
                    refreshUserData();
                } catch (e) {
                    console.error("Error joining class: ", e);
                    setModalState({ isOpen: true, title: '오류', content: '학급 가입 요청에 실패했습니다.' });
                }
                setIsLoading(false);
            };

            return (
                <div className="max-w-xl mx-auto space-y-8">
                    <div className="bg-white rounded-xl shadow-md p-8">
                        <h3 className="text-xl font-bold mb-4 text-gray-800">비밀번호 변경</h3>
                        <div className="flex gap-2">
                            <input type="password" className="flex-1 p-2 border rounded-lg" placeholder="새 비밀번호 (숫자 6자리 이상)" value={newPassword} onChange={e => setNewPassword(e.target.value.replace(/[^0-9]/g, ''))} minLength={6} />
                            <button type="button" className="btn-rose !px-4 !py-2" onClick={handleChangePassword} disabled={isLoading}>{isLoading ? '변경중...' : '변경'}</button>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-md p-8">
                        <h3 className="text-xl font-bold mb-4 text-gray-800">새 학급 가입</h3>
                        <div className="flex gap-2">
                            <input type="text" className="flex-1 p-2 border rounded-lg uppercase" placeholder="학급코드 (6자리)" value={classCode} onChange={e => setClassCode(e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, ''))} maxLength={6} />
                            <button type="button" className="btn-rose !px-4 !py-2" onClick={handleJoinClass} disabled={isLoading}>{isLoading ? '신청중...' : '신청'}</button>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">* 새로운 학급에 참여하려면 교사의 승인이 필요합니다.</p>
                    </div>
                </div>
            );
        };
        
        // --- 신규/수정된 메뉴: 시험 점수 ---
        const StudentScoreCard = ({ studentScore, headers }) => {
            if (!studentScore) {
                return (
                    <div className="bg-white p-8 rounded-lg shadow-md text-center">
                        <p className="text-gray-600">학생 점수 정보를 찾을 수 없습니다.</p>
                    </div>
                );
            }

            const scoreHeaders = headers.filter(h => h && h !== '학번' && h !== '이름' && h !== '총점' && h !== '번호' && h !== 'studentId');
            const totalScoreHeader = headers.find(h => h === '총점');

            return (
                <div className="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <div className="border-b pb-4 mb-6 flex justify-between items-baseline">
                        <h3 className="text-2xl font-bold text-gray-800">{studentScore['이름']} <span className="text-lg font-medium text-gray-500">({studentScore['studentId']})</span></h3>
                    </div>
                    
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 mb-8">
                        {scoreHeaders.map(header => (
                            <div key={header} className="flex justify-between items-center border-b py-2">
                                <span className="text-gray-600">{header}</span>
                                <span className="font-mono text-lg font-semibold text-gray-800">{studentScore[header] ?? '-'} 점</span>
                            </div>
                        ))}
                    </div>

                    {totalScoreHeader && (
                        <div className="mt-8 pt-6 border-t-2 border-sky-500 flex justify-between items-center">
                            <span className="text-xl font-bold text-gray-800">{totalScoreHeader}</span>
                            <span className="font-mono text-3xl font-extrabold text-sky-600">{studentScore[totalScoreHeader] ?? '-'} 점</span>
                        </div>
                    )}
                </div>
            );
        };

        const TestScoreViewer = ({ userData, isTeacher, selectedClass, setModalState }) => {
            const [scoresData, setScoresData] = useState({ headers: [], rows: [] });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [selectedStudentId, setSelectedStudentId] = useState('all');
            const [sheetUrl, setSheetUrl] = useState('');

            const extractSheetId = (url) => {
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            };

            const handleLinkSheet = async () => {
                const sheetId = extractSheetId(sheetUrl);
                if (!sheetId) {
                    setModalState({ isOpen: true, title: '오류', content: '유효한 Google Sheets URL을 입력해주세요.' });
                    return;
                }
                await db.collection('classes').doc(selectedClass.id).update({ googleSheetId: sheetId });
                setModalState({ isOpen: true, title: '성공', content: 'Google 시트가 성공적으로 연동되었습니다.' });
            };
            
            const handleUnlinkSheet = async () => {
                 await db.collection('classes').doc(selectedClass.id).update({ googleSheetId: FieldValue.delete() });
                 setModalState({ isOpen: true, title: '성공', content: 'Google 시트 연동이 해제되었습니다.' });
            }

            useEffect(() => {
                if (!selectedClass?.googleSheetId) {
                    setScoresData({ headers: [], rows: [] });
                    setLoading(false);
                    setError(null);
                    return;
                }
                
                const fetchSheetData = async () => {
                    setLoading(true);
                    setError(null);
                    
                    const SHEET_ID = selectedClass.googleSheetId;
                    const sheetName = selectedClass.className.replace(/[^0-9]/g, '');
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}&headers=1`;

                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('시트 정보를 불러올 수 없습니다. 공유 설정을 확인해주세요.');
                        
                        const text = await res.text();
                        const jsonString = text.substring(47).slice(0, -2);
                        const json = JSON.parse(jsonString);

                        if (json.status === 'error' || !json.table || !json.table.cols || json.table.rows.length < 2) {
                            throw new Error(`시트 '${sheetName}'에 데이터가 없거나 형식이 올바르지 않습니다. (헤더 1행, 만점 2행, 데이터 3행부터)`);
                        }

                        const headers = json.table.cols.map(col => col.label || col.id).filter(label => label);
                        const dataRows = json.table.rows.slice(1);
                        
                        const rows = dataRows.map(row => {
                            const rowData = {};
                            if (row && row.c) {
                                row.c.forEach((cell, idx) => {
                                    if (headers[idx]) {
                                        rowData[headers[idx]] = cell ? cell.v : null;
                                    }
                                });
                            }
                            
                            const studentNum = rowData['번호']?.toString().padStart(2, '0');
                            if (studentNum) {
                                rowData['studentId'] = `${sheetName}${studentNum}`;
                            }
                            return rowData;
                        }).filter(row => row.studentId);

                        setScoresData({ headers, rows });

                    } catch(err) {
                        console.error("Error fetching sheet:", err);
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchSheetData();
            }, [selectedClass]);

            if (loading) {
                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6 text-gray-800">시험 점수</h2>
                        <div className="bg-white p-8 rounded-lg shadow-md text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto"></div>
                            <p className="mt-4 text-gray-600">데이터를 불러오는 중입니다...</p>
                        </div>
                    </div>
                );
            }
            
            if (isTeacher && !selectedClass.googleSheetId) {
                 return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6 text-gray-800">시험 점수</h2>
                        <div className="bg-white p-8 rounded-lg shadow-md">
                            <h3 className="text-xl font-bold text-gray-700 mb-2">Google 시트 연동</h3>
                            <p className="text-gray-500 mb-4">
                                이 학급의 시험 점수를 관리할 Google 시트의 URL을 입력해주세요.
                                <br/>
                                <span className="text-sm text-red-500">* 시트는 '링크가 있는 모든 사용자에게' 뷰어로 공유되어야 합니다.</span>
                            </p>
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={sheetUrl}
                                    onChange={e => setSheetUrl(e.target.value)}
                                    className="w-full p-2 border rounded-md" 
                                    placeholder="Google Sheets URL 붙여넣기"
                                />
                                <button onClick={handleLinkSheet} className="btn-sky !px-4 !py-2">연동하기</button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6 text-gray-800">시험 점수</h2>
                        <div className="bg-white p-8 rounded-lg shadow-md text-center text-red-500">
                            <p>오류: {error}</p>
                            {isTeacher && <button onClick={handleUnlinkSheet} className="btn-red !px-4 !py-2 mt-4">시트 연동 해제</button>}
                        </div>
                    </div>
                );
            }
            
            if (isTeacher) {
                const selectedStudentScore = selectedStudentId !== 'all' 
                    ? scoresData.rows.find(row => row.studentId === selectedStudentId)
                    : null;

                return (
                    <div>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold text-gray-800">시험 점수</h2>
                            <button onClick={handleUnlinkSheet} className="btn-gray !px-4 !py-2">시트 연동 해제</button>
                        </div>
                        <div className="mb-6 max-w-sm">
                            <label htmlFor="student-score-select" className="block text-sm font-medium text-gray-700 mb-1">학생 선택</label>
                            <select 
                                id="student-score-select"
                                className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"
                                value={selectedStudentId} 
                                onChange={e => setSelectedStudentId(e.target.value)}
                            >
                                <option value="all">전체 학생 표로 보기</option>
                                {scoresData.rows.map(student => (
                                    <option key={student.studentId} value={student.studentId}>
                                        {student.이름} ({student.studentId})
                                    </option>
                                ))}
                            </select>
                        </div>

                        {selectedStudentId === 'all' ? (
                            <div className="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                                <table className="w-full text-left min-w-[800px]">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            {scoresData.headers.map(header => (
                                                <th key={header} className="p-3 font-bold text-center">{header}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {scoresData.rows.map((row, index) => (
                                            <tr key={index} className="border-b hover:bg-gray-50">
                                                {scoresData.headers.map(header => (
                                                    <td key={header} className="p-3 font-mono text-center">{row[header]}</td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <StudentScoreCard studentScore={selectedStudentScore} headers={scoresData.headers} />
                        )}
                    </div>
                );
            }
            
            if (!userData || !userData.studentId) return <p>학생 정보를 불러올 수 없습니다.</p>;
            
            const studentScore = scoresData.rows.find(row => row.studentId === userData.studentId);

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6 text-gray-800">나의 시험 점수</h2>
                    {studentScore ? (
                        <StudentScoreCard studentScore={studentScore} headers={scoresData.headers} />
                    ) : (
                        <div className="bg-white p-8 rounded-lg shadow-md text-center">
                            <p className="text-gray-600">아직 이 학급의 시험 점수가 등록되지 않았습니다.</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- 신규 기능: 수행 점수 관리 ---
        const StudentPerformanceCard = ({ headers, studentRecord }) => {
            if (!studentRecord) {
                return (
                    <div className="bg-white p-8 rounded-lg shadow-md text-center">
                        <p className="text-gray-600">아직 나의 수행평가 점수가 등록되지 않았습니다.</p>
                    </div>
                );
            }

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <div className="border-b pb-4 mb-6">
                        <h3 className="text-2xl font-bold text-gray-800">{studentRecord.name} <span className="text-lg font-medium text-gray-500">({studentRecord.studentId})</span></h3>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[600px] border-collapse">
                             <thead>
                                <tr className="bg-gray-50">
                                    {headers.map((header, index) => (
                                        <th key={index} className="p-3 font-semibold text-center border-b">{header.name}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {headers.map((header, index) => (
                                        <td key={index} className="p-3 text-center font-mono border-b">{header.perfectScore}</td>
                                    ))}
                                </tr>
                                <tr className="bg-rose-50">
                                    {studentRecord.scores.map((score, index) => (
                                        <td key={index} className="p-3 text-center font-bold text-lg text-rose-600 font-mono">{score}</td>
                                    ))}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PerformanceScoreManager = ({ isTeacher, userData, selectedClass, setModalState }) => {
            const [assessmentData, setAssessmentData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedStudentId, setSelectedStudentId] = useState('all');

            // 교사 업로드용 상태
            const [grade, setGrade] = useState('');
            const [file, setFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (!selectedClass?.id) {
                    setLoading(false);
                    return;
                }
                setLoading(true);
                const unsub = db.collection(CONSTANTS.COLLECTIONS.ASSESSMENTS).doc(selectedClass.id).onSnapshot(doc => {
                    if (doc.exists) {
                        setAssessmentData(doc.data());
                        setError(null);
                    } else {
                        setAssessmentData(null);
                    }
                    setLoading(false);
                }, err => {
                    console.error(err);
                    setError('데이터를 불러오는 중 오류가 발생했습니다. Firestore 보안 규칙을 확인해주세요.');
                    setLoading(false);
                });

                return () => unsub();
            }, [selectedClass?.id]);

            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (f && (f.name.endsWith('.xlsx') || f.name.endsWith('.xls'))) {
                    setFile(f);
                } else {
                    setModalState({ isOpen: true, title: '파일 형식 오류', content: '엑셀 파일(.xlsx, .xls)만 업로드할 수 있습니다.' });
                    setFile(null);
                    if (fileInputRef.current) fileInputRef.current.value = "";
                }
            };

            const handleUpload = () => {
                if (!file) {
                    setModalState({ isOpen: true, title: '파일 없음', content: '업로드할 엑셀 파일을 선택해주세요.' });
                    return;
                }
                if (!grade) {
                    setModalState({ isOpen: true, title: '학년 미선택', content: '점수를 등록할 학년을 선택해주세요.' });
                    return;
                }

                setUploading(true);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                        if (jsonData.length < 4) throw new Error("엑셀 파일의 형식이 올바르지 않습니다. (최소 4줄 필요)");
                        
                        const headerRow = jsonData[0]; 
                        const perfectScoreRow = jsonData[1]; 
                        const studentDataRows = jsonData.slice(3);

                        const assessmentHeaders = [];
                        const scoreColumnIndices = [];
                        headerRow.forEach((header, index) => {
                            if (index > 3 && header && header.toString().trim() !== "") {
                                assessmentHeaders.push({
                                    name: header.toString(),
                                    perfectScore: perfectScoreRow[index]?.toString() || 'N/A'
                                });
                                scoreColumnIndices.push(index);
                            }
                        });

                        const studentScores = studentDataRows.map(row => {
                            const classNum = row[1]?.toString(); 
                            const studentNum = row[2]?.toString();
                            const studentName = row[3]?.toString();

                            if (!classNum || !studentNum || !studentName) return null;

                            return {
                                studentId: `${grade}${classNum}${studentNum.padStart(2, '0')}`,
                                name: studentName,
                                scores: scoreColumnIndices.map(colIndex => row[colIndex]?.toString() || '-')
                            };
                        }).filter(Boolean);

                        const dataToSave = {
                            grade: grade,
                            fileName: file.name,
                            uploadedAt: new Date().toISOString(),
                            headers: assessmentHeaders,
                            scores: studentScores
                        };

                        await db.collection(CONSTANTS.COLLECTIONS.ASSESSMENTS).doc(selectedClass.id).set(dataToSave);
                        setModalState({ isOpen: true, title: '업로드 성공', content: '수행평가 점수를 성공적으로 등록했습니다.' });
                        setFile(null);
                        setGrade('');
                        if (fileInputRef.current) fileInputRef.current.value = "";

                    } catch (err) {
                        console.error("Upload error:", err);
                        setModalState({ isOpen: true, title: '업로드 실패', content: `파일 처리 중 오류가 발생했습니다: ${err.message}` });
                    } finally {
                        setUploading(false);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleDelete = () => {
                setModalState({
                    isOpen: true,
                    isConfirm: true,
                    title: "점수 삭제 확인",
                    content: `이 학급의 모든 수행평가 점수 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`,
                    confirmText: '삭제',
                    onConfirm: async () => {
                        await db.collection(CONSTANTS.COLLECTIONS.ASSESSMENTS).doc(selectedClass.id).delete();
                        setModalState({ isOpen: true, title: '삭제 완료', content: '점수 데이터가 삭제되었습니다.' });
                    }
                });
            };

            if (loading) {
                return <div className="h-64 w-full skeleton"></div>;
            }
            if (error) {
                return <div className="bg-red-100 text-red-700 p-4 rounded-lg">{error}</div>;
            }

            if (isTeacher) {
                const selectedStudentRecord = selectedStudentId !== 'all' 
                    ? assessmentData?.scores.find(s => s.studentId === selectedStudentId)
                    : null;

                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6 text-gray-800">수행 점수 관리</h2>
                        {!assessmentData ? (
                            <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                                <h3 className="text-xl font-bold mb-4">점수 파일 업로드</h3>
                                <div className="grid md:grid-cols-3 gap-4 items-end">
                                    <div className="w-full">
                                        <label className="text-sm font-medium text-gray-600">학년 선택</label>
                                        <select value={grade} onChange={e => setGrade(e.target.value)} className="w-full mt-1 p-2 border rounded-md">
                                            <option value="">-- 학년 --</option>
                                            <option value="1">1학년</option>
                                            <option value="2">2학년</option>
                                            <option value="3">3학년</option>
                                        </select>
                                    </div>
                                    <div className="w-full">
                                        <label className="text-sm font-medium text-gray-600">엑셀 파일</label>
                                        <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".xlsx, .xls" className="w-full mt-1 text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                                    </div>
                                    <button onClick={handleUpload} disabled={uploading} className="btn-sky w-full !py-2">
                                        {uploading ? '업로드 중...' : '업로드'}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold mb-2">현재 등록된 점수 정보</h3>
                                            <p className="text-sm text-gray-500">파일: {assessmentData.fileName}</p>
                                            <p className="text-sm text-gray-500">업로드 일시: {new Date(assessmentData.uploadedAt).toLocaleString()}</p>
                                        </div>
                                        <button onClick={handleDelete} className="btn-red !px-4 !py-2">데이터 삭제</button>
                                    </div>
                                    <div className="max-w-sm">
                                        <label htmlFor="student-perf-select" className="block text-sm font-medium text-gray-700 mb-1">학생 선택</label>
                                        <select 
                                            id="student-perf-select"
                                            className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500"
                                            value={selectedStudentId} 
                                            onChange={e => setSelectedStudentId(e.target.value)}
                                        >
                                            <option value="all">전체 학생 표로 보기</option>
                                            {assessmentData.scores.map(student => (
                                                <option key={student.studentId} value={student.studentId}>
                                                    {student.name} ({student.studentId})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                {selectedStudentId === 'all' ? (
                                    <div className="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                                        <p className="text-center text-gray-500">전체 학생 점수 표가 여기에 표시됩니다.</p>
                                    </div>
                                ) : (
                                    <StudentPerformanceCard headers={assessmentData.headers} studentRecord={selectedStudentRecord} />
                                )}
                            </div>
                        )}
                    </div>
                );
            }

            // 학생 뷰
            const studentRecord = assessmentData?.scores.find(s => s.studentId === userData.studentId);
            return (
                <div>
                     <h2 className="text-3xl font-bold mb-6 text-gray-800">나의 수행 점수</h2>
                     {assessmentData ? 
                        <StudentPerformanceCard headers={assessmentData.headers} studentRecord={studentRecord} /> :
                        <div className="bg-white p-8 rounded-lg shadow-md text-center">
                            <p className="text-gray-600">아직 이 학급의 수행평가 점수가 등록되지 않았습니다.</p>
                        </div>
                     }
                </div>
            );
        };


        // --- 대시보드 (통합 및 개선) ---
        const Dashboard = ({ user, initialUserData, onLogout }) => {
            const [userData, setUserData] = useState(initialUserData);
            const [isSidebarExpanded, setIsSidebarExpanded] = useState(true);
            const [currentMenu, setCurrentMenu] = useState('schedule');
            const [classes, setClasses] = useState([]);
            const [selectedClassId, setSelectedClassId] = useState('');
            const [classData, setClassData] = useState({ students: [], pendingStudents: [] });
            const [allSchoolStudents, setAllSchoolStudents] = useState([]);
            const [loading, setLoading] = useState({ classes: true, classData: true, allStudents: true });
            const [modalState, setModalState] = useState({ isOpen: false });
            const [isClassCodeVisible, setIsClassCodeVisible] = useState(true);
            
            const isTeacher = user.role === 'teacher';
            const selectedClass = useMemo(() => classes.find(cls => cls.id === selectedClassId), [classes, selectedClassId]);
            const sidebarRef = useRef(null);

            const refreshUserData = useCallback(async () => {
                if(isTeacher) return;
                const studentRef = db.collection('students').doc(user.uid);
                const studentDoc = await studentRef.get();
                if(studentDoc.exists) {
                    const studentProfile = studentDoc.data();
                    const classDetails = [];
                    if (studentProfile.classIds && studentProfile.classIds.length > 0) {
                        const classPromises = studentProfile.classIds.map(id => db.collection('classes').doc(id).get());
                        const classDocs = await Promise.all(classPromises);
                        classDocs.forEach(doc => {
                            if (doc.exists) classDetails.push({ id: doc.id, ...doc.data() });
                        });
                    }
                    setUserData({ ...studentProfile, classDetails });
                }
            }, [user.uid, isTeacher]);

            useEffect(() => {
                if(isTeacher) {
                    const unsub = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).onSnapshot(snapshot => {
                        const studentList = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        setAllSchoolStudents(studentList);
                        setLoading(prev => ({...prev, allStudents: false}));
                    });
                    return () => unsub();
                } else {
                    setLoading(prev => ({...prev, allStudents: false}));
                }
            }, [isTeacher]);

            useEffect(() => {
                let unsub = () => {};
                if (isTeacher) {
                    unsub = db.collection(CONSTANTS.COLLECTIONS.CLASSES).where('teacherId', '==', user.uid).onSnapshot(snapshot => {
                        const classList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.className.localeCompare(b.className));
                        setClasses(classList);
                        if (classList.length > 0 && (!selectedClassId || !classList.some(c => c.id === selectedClassId))) {
                            setSelectedClassId(classList[0].id);
                        } else if (classList.length === 0) setSelectedClassId('');
                        setLoading(prev => ({ ...prev, classes: false }));
                    });
                } else {
                    const unsubStudent = db.collection('students').doc(user.uid).onSnapshot(async (studentDoc) => {
                        if (studentDoc.exists) {
                            const studentProfile = studentDoc.data();
                            const approvedClassIds = Object.keys(studentProfile.approvedBy || {}).filter(key => studentProfile.approvedBy[key]);
                            
                            if (approvedClassIds.length > 0) {
                                const classPromises = approvedClassIds.map(id => db.collection('classes').doc(id).get());
                                const classDocs = await Promise.all(classPromises);
                                const classList = classDocs.filter(doc => doc.exists).map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.className.localeCompare(b.className));
                                setClasses(classList);
                                 if (classList.length > 0 && (!selectedClassId || !classList.some(c => c.id === selectedClassId))) {
                                     setSelectedClassId(classList[0].id);
                                } else if (classList.length === 0) {
                                     setSelectedClassId('');
                                }
                            } else {
                                setClasses([]);
                                setSelectedClassId('');
                            }
                        }
                        setLoading(prev => ({ ...prev, classes: false }));
                    });
                    return () => unsubStudent();
                }
                return () => unsub();
            }, [user.uid, isTeacher]);

            useEffect(() => {
                if (!selectedClassId || !isTeacher) {  
                    setClassData({ students: [], pendingStudents: [] });
                    setLoading(prev => ({ ...prev, classData: false }));  
                    return;  
                }
                setLoading(prev => ({ ...prev, classData: true }));
                const studentsUnsub = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where('classIds', 'array-contains', selectedClassId).onSnapshot(snapshot => {
                    const allStudentsInClass = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setClassData({ 
                        students: allStudentsInClass.filter(s => s.approvedBy?.[selectedClassId]).sort((a, b) => String(a.studentId).localeCompare(String(b.studentId))), 
                        pendingStudents: allStudentsInClass.filter(s => !s.approvedBy?.[selectedClassId]).sort((a, b) => String(a.studentId).localeCompare(String(b.studentId)))
                    });
                    setLoading(prev => ({ ...prev, classData: false }));
                });
                return () => studentsUnsub();
            }, [selectedClassId, isTeacher]);
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (window.innerWidth < 768 && isSidebarExpanded && sidebarRef.current && !sidebarRef.current.contains(event.target)) {
                        setIsSidebarExpanded(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [isSidebarExpanded]);

            const handleClassChange = (newClassId) => {
                setSelectedClassId(newClassId);
                setCurrentMenu('schedule');
            };

            const approveStudent = async (studentId) => {
                await db.collection(CONSTANTS.COLLECTIONS.STUDENTS).doc(studentId).update({ [`approvedBy.${selectedClassId}`]: true });
                setModalState({ isOpen: true, title: '성공', content: '학생을 학급에 가입시켰습니다.' });
            };
            
            const rejectStudent = async (studentId) => {
                const studentRef = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).doc(studentId);
                await studentRef.update({
                    classIds: FieldValue.arrayRemove(selectedClassId),
                    [`approvedBy.${selectedClassId}`]: FieldValue.delete()
                });
                setModalState({ isOpen: true, title: '성공', content: '학생의 가입 요청을 거절했습니다.' });
            };

            const inviteStudent = async (student, targetClassId) => {
                const studentRef = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).doc(student.id);
                await studentRef.update({
                    classIds: FieldValue.arrayUnion(targetClassId),
                    [`approvedBy.${targetClassId}`]: false
                });
                setModalState({ isOpen: true, title: '초대 완료', content: `${student.name} 학생을 ${classes.find(c=>c.id === targetClassId)?.className} 학급으로 초대했습니다. 해당 학급에서 가입 승인이 필요합니다.` });
            };

            const handleDeleteStudent = (studentToDelete) => {
                setModalState({
                    isOpen: true, isConfirm: true, title: "학생 제외 확인",
                    content: `${studentToDelete.name}(${studentToDelete.studentId}) 학생을 이 학급에서 제외하시겠습니까? 학생의 계정은 삭제되지 않습니다.`,
                    confirmText: '제외',
                    onConfirm: async () => {
                        const studentRef = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).doc(studentToDelete.id);
                        await studentRef.update({
                            classIds: FieldValue.arrayRemove(selectedClassId),
                            [`approvedBy.${selectedClassId}`]: FieldValue.delete()
                        });
                        setModalState({ isOpen: true, title: '성공', content: '학생을 학급에서 제외했습니다.' });
                    }
                });
            };

            const handleUpdateClass = async (classId, data) => {
                await db.collection('classes').doc(classId).update(data);
                setModalState({ isOpen: true, title: '성공', content: '학급 정보가 수정되었습니다.' });
            };

            const handleDeleteClass = async (classIdToDelete) => {
                setModalState({ isOpen: true, isConfirm: false, title: '학급 삭제 중', content: '학급 정보를 확인하고 있습니다...' });

                try {
                    const studentsQuery = db.collection('students').where('classIds', 'array-contains', classIdToDelete);
                    const studentsSnapshot = await studentsQuery.get();
                    
                    if (!studentsSnapshot.empty) {
                        setModalState({ isOpen: true, isConfirm: false, title: '학급 삭제 중', content: `연결된 ${studentsSnapshot.size}명의 학생 정보를 업데이트합니다...` });
                        const studentUpdateBatch = db.batch();
                        studentsSnapshot.docs.forEach(doc => {
                            const studentRef = db.collection('students').doc(doc.id);
                            studentUpdateBatch.update(studentRef, {
                                classIds: FieldValue.arrayRemove(classIdToDelete),
                                [`approvedBy.${classIdToDelete}`]: FieldValue.delete()
                            });
                        });
                        await studentUpdateBatch.commit();
                    }

                    setModalState({ isOpen: true, isConfirm: false, title: '학급 삭제 중', content: '학생 정보 업데이트 완료. 학급 관련 데이터를 삭제합니다...' });
                    const classDeleteBatch = db.batch();
                    
                    classDeleteBatch.delete(db.collection('classes').doc(classIdToDelete));
                    classDeleteBatch.delete(db.collection('schedules').doc(classIdToDelete));
                    classDeleteBatch.delete(db.collection('scores').doc(classIdToDelete));
                    classDeleteBatch.delete(db.collection('assessments').doc(classIdToDelete));
                    
                    await classDeleteBatch.commit();

                    setModalState({ isOpen: true, title: '삭제 완료', content: '학급이 성공적으로 삭제되었습니다.' });

                } catch (error) {
                    console.error("학급 삭제 오류:", error);
                    setModalState({ isOpen: true, title: '삭제 실패', content: `오류가 발생했습니다: ${error.message}` });
                }
            };

            const teacherMenuItems = [  
                { id: 'schedule', label: '일정 관리', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> },
                { id: 'students', label: '학생 관리', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> },
                { id: 'scores', label: '수행 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg> },
                { id: 'test-scores', label: '시험 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> },
                { id: 'class', label: '학급 설정', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> },
            ];
            
            const studentMenuItems = [
                { id: 'schedule', label: '일정 확인', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> },
                { id: 'scores', label: '수행 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg> },
                { id: 'test-scores', label: '시험 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> },
                { id: 'info', label: '개인 설정', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> }
            ];

            const menuItems = isTeacher ? teacherMenuItems : studentMenuItems;
            const themeColor = isTeacher ? 'sky' : 'rose';
            const hoverBg = isTeacher ? 'hover:bg-sky-100' : 'hover:bg-rose-100';

            const renderContent = () => {
                if(loading.classes || (isTeacher && loading.classData)) return <div className="h-full w-full skeleton"></div>;
                if(!selectedClassId && !['class', 'info'].includes(currentMenu)) {
                    return <div className="text-center text-gray-500 p-10 bg-white rounded-lg shadow-md"><p className="text-xl font-bold">참여 중인 학급이 없습니다.</p><p className="mt-2">{isTeacher ? "'학급 설정' 메뉴에서 학급을 생성해주세요." : "'개인 설정' 메뉴에서 학급에 참여하세요."}</p></div>;
                }
                switch (currentMenu) {
                    case 'schedule': return <ScheduleCalendar classes={classes} selectedClass={selectedClass} selectedClassId={selectedClassId} students={classData.students} allSchoolStudents={allSchoolStudents} teacherId={user.uid} isTeacher={isTeacher} setModalState={setModalState} />;
                    case 'class': return isTeacher ? <ClassManagement teacherId={user.uid} classes={classes} setModalState={setModalState} onUpdateClass={handleUpdateClass} onDeleteClass={handleDeleteClass} /> : null;
                    case 'students': return isTeacher ? <StudentManagement students={classData.students} pendingStudents={classData.pendingStudents} deleteStudent={handleDeleteStudent} approveStudent={approveStudent} rejectStudent={rejectStudent} inviteStudent={inviteStudent} classes={classes} /> : null;
                    case 'scores': return <PerformanceScoreManager isTeacher={isTeacher} userData={userData} selectedClass={selectedClass} setModalState={setModalState} />;
                    case 'test-scores': return <TestScoreViewer isTeacher={isTeacher} userData={userData} selectedClass={selectedClass} setModalState={setModalState} />;
                    case 'info': return isTeacher ? null : <StudentInfo user={user} userData={userData} setModalState={setModalState} refreshUserData={refreshUserData} />;
                    default: return null;
                }
            };
            
            return (
                <div className="flex h-screen bg-gray-100">
                    <Modal modalState={modalState} setModalState={setModalState} />
                    <aside ref={sidebarRef} className={`sidebar bg-white shadow-lg flex flex-col z-20 absolute md:relative inset-y-0 left-0 transform md:transform-none ${isSidebarExpanded ? "w-64" : "w-20"} ${isSidebarExpanded ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="flex flex-col flex-grow overflow-y-hidden">
                            <div className="flex-shrink-0 flex items-center justify-center p-2 border-b relative" style={{ minHeight: '60px' }}>
                                {isSidebarExpanded && <span className={`text-2xl font-bold text-${themeColor}-500`}>기가지현</span>}
                                <button onClick={() => setIsSidebarExpanded(!isSidebarExpanded)} className="p-2 rounded-lg hover:bg-gray-100 absolute top-3 right-3">{isSidebarExpanded ? <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg> }</button>
                            </div>
                            <div className="flex-grow overflow-y-auto p-2">
                                {isSidebarExpanded ? (
                                    <div>
                                        <p className="text-sm text-gray-500 mt-2 mb-4 text-center">{userData.name} {isTeacher ? '선생님' : '학생'}</p>
                                        {isTeacher && (
                                            <div className="my-4 mx-2">
                                                <div className="flex items-center justify-center mb-2 cursor-pointer" onClick={() => setIsClassCodeVisible(prev => !prev)}>
                                                    <label className="text-sm font-bold text-gray-600">현재 학급 코드</label>
                                                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 ml-1 text-gray-500 transition-transform ${isClassCodeVisible ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                                      <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                                                    </svg>
                                                </div>
                                                {isClassCodeVisible && (
                                                    <div className="w-full bg-sky-100 text-sky-800 rounded-lg p-4 flex items-center justify-center h-24 cursor-pointer" onClick={() => navigator.clipboard.writeText(selectedClass?.classCode)} title="클릭하여 복사">
                                                        {loading.classes ? (<div className="h-12 w-40 mx-auto skeleton"></div>) : (<p className="text-4xl font-black tracking-widest text-center">{selectedClass?.classCode || '----'}</p>)}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        <div className="my-4 px-2">
                                            <label htmlFor="class-select" className="text-sm font-bold text-gray-600 mb-2 block">학급 전환</label>
                                            <select id="class-select" className="w-full border rounded-lg p-2 bg-gray-50" value={selectedClassId} onChange={e => handleClassChange(e.target.value)} disabled={classes.length === 0}>
                                                {classes.length > 0 ? (classes.map(cls => <option key={cls.id} value={cls.id}>{cls.className}</option>)) : ( <option>참여 학급 없음</option> )}
                                            </select>
                                        </div>
                                    </div>
                                ) : (<div className="my-4 text-center"><p className={`text-xs font-bold text-gray-600 truncate p-2 bg-${themeColor}-100 rounded-md`}>{selectedClass?.className || 'N/A'}</p></div>)}
                                <nav className="space-y-1">{menuItems.map(item => (<button key={item.id} onClick={() => setCurrentMenu(item.id)} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors ${!isSidebarExpanded && 'justify-center'} ${currentMenu === item.id ? `bg-${themeColor}-500 text-white font-bold shadow` : `text-gray-600 ${hoverBg}`}`} title={isSidebarExpanded ? '' : item.label}>{item.icon}{isSidebarExpanded && <span>{item.label}</span>}</button>))} </nav>
                            </div>
                        </div>
                        <div className="p-2 border-t border-gray-200 flex-shrink-0">
                            <button onClick={onLogout} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-200 ${!isSidebarExpanded && 'justify-center'}`} title={isSidebarExpanded ? '' : "로그아웃"}><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>{isSidebarExpanded && <span>로그아웃</span>}</button>
                        </div>
                    </aside>
                    <div className="flex-1 flex flex-col">
                        <button onClick={() => setIsSidebarExpanded(true)} className="md:hidden p-2 bg-white/50 backdrop-blur-sm rounded-full shadow-md fixed top-4 left-4 z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                        <main className="flex-1 p-4 sm:p-8 overflow-y-auto">{renderContent()}</main>
                    </div>
                </div>
            );
        };
        
        // --- 인증 및 메인 App ---
        const AuthForm = ({ title, buttonText, onSubmit, onSwitchToSignup, onBack, isTeacher }) => {
            const [field1, setField1] = useState('');
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(field1, password); };
            const buttonClass = isTeacher ? 'btn-sky' : 'btn-rose';
            const linkColor = isTeacher ? 'text-sky-600' : 'text-rose-600';
            return (
                <div className="w-full bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-8">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">{title}</h2>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div>
                            <label className="text-sm font-medium text-gray-600">{isTeacher ? '학교 구글 계정 ID' : '아이디 (학번)'}</label>
                            {isTeacher ? (<div className="flex items-center mt-1"><input type="text" value={field1} onChange={e => setField1(e.target.value)} className="w-full p-3 border rounded-l-lg outline-none" required /><span className="bg-gray-200 p-3 border-l-0 rounded-r-lg">@{CONSTANTS.SCHOOL_DOMAIN}</span></div>) : (<input type="text" pattern="[0-9]*" value={field1} onChange={e => setField1(e.target.value.replace(/[^0-9]/g, ''))} className="w-full mt-1 p-3 border rounded-lg outline-none" required maxLength="4" />)}
                        </div>
                        <div>
                            <label className="text-sm font-medium text-gray-600">비밀번호</label>
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full mt-1 p-3 border rounded-lg outline-none" required />
                        </div>
                        <button type="submit" className={`w-full py-3 ${buttonClass}`}>{buttonText}</button>
                    </form>
                    <div className="text-sm text-center mt-6 flex justify-between">
                        <a href="#" onClick={(e) => { e.preventDefault(); onSwitchToSignup(); }} className={`font-medium ${linkColor}`}>회원 가입</a>
                        <a href="#" onClick={(e) => { e.preventDefault(); onBack(); }} className="font-medium text-gray-600">뒤로가기</a>
                    </div>
                </div>
            );
        };
        const StudentSignUpForm = ({ onSubmit, onSwitchToLogin, onBack }) => {
            const [name, setName] = useState('');
            const [studentId, setStudentId] = useState('');
            const [password, setPassword] = useState('');
            const [classCode, setClassCode] = useState('');
            const [schoolAccountId, setSchoolAccountId] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(name, studentId, password, classCode, schoolAccountId); };
            return (
                <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-8">
                    <h2 className="text-2xl font-bold mb-4 text-center">학생 회원가입</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="text" placeholder="이름" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 border rounded-lg" required />
                        <input type="text" placeholder="아이디 (학번 4자리)" value={studentId} onChange={e => setStudentId(e.target.value.replace(/[^0-9]/g, ''))} className="w-full p-3 border rounded-lg" required maxLength="4" />
                        <div className="flex items-center">
                            <input type="text" placeholder="학교 구글 계정 ID" value={schoolAccountId} onChange={e => setSchoolAccountId(e.target.value)} className="w-full p-3 border rounded-l-lg" required />
                            <span className="bg-gray-200 p-3 border-l-0 rounded-r-lg">@{CONSTANTS.SCHOOL_DOMAIN}</span>
                        </div>
                        <input type="password" placeholder="비밀번호 (숫자 6자 이상)" value={password} onChange={e => setPassword(e.target.value.replace(/[^0-9]/g, ''))} className="w-full p-3 border rounded-lg" required minLength="6" />
                        <input type="text" placeholder="학급코드 (선생님께 받은 6자리)" value={classCode} onChange={e => setClassCode(e.target.value.toUpperCase())} className="w-full p-3 border rounded-lg" required maxLength="6" />
                        <button type="submit" className="w-full btn-rose py-3">가입 신청</button>
                    </form>
                    <div className="text-sm text-center mt-6 flex justify-between">
                        <a href="#" onClick={(e) => { e.preventDefault(); onSwitchToLogin(); }} className="font-medium text-rose-600">이미 계정이 있나요?</a>
                        <a href="#" onClick={(e) => { e.preventDefault(); onBack(); }} className="font-medium text-gray-600">뒤로가기</a>
                    </div>
                </div>
            );
        };
        
        const TeacherSignUpForm = ({ onSubmit, onSwitchToLogin, onBack }) => {
            const [name, setName] = useState('');
            const [accountId, setAccountId] = useState('');
            const [password, setPassword] = useState('');
            const [className, setClassName] = useState('');
            const [classCode, setClassCode] = useState('');

            const handleClassCodeChange = (value) => {
                const upperValue = value.toUpperCase();
                let filteredValue = '';
                if (upperValue.length > 0) {
                    const firstChar = upperValue.substring(0, 1).replace(/[^A-Z]/g, '');
                    const restChars = upperValue.substring(1).replace(/[^A-Z0-9]/g, '');
                    filteredValue = firstChar + restChars;
                }
                setClassCode(filteredValue);
            };

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                onSubmit(name, accountId, password, className, classCode); 
            };

            return (
                <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-8">
                    <h2 className="text-2xl font-bold mb-4 text-center">교사 회원가입</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="text" placeholder="이름" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 border rounded-lg" required />
                        <div className="flex items-center">
                            <input type="text" placeholder="학교 구글 계정 ID" value={accountId} onChange={e => setAccountId(e.target.value)} className="w-full p-3 border rounded-l-lg" required />
                            <span className="bg-gray-200 p-3 border-l-0 rounded-r-lg">@{CONSTANTS.SCHOOL_DOMAIN}</span>
                        </div>
                        <input type="password" placeholder="비밀번호 (6자 이상)" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 border rounded-lg" required minLength="6" />
                        <input type="text" placeholder="첫 학급 이름 (예: 1학년 1반)" value={className} onChange={e => setClassName(e.target.value)} className="w-full p-3 border rounded-lg" required />
                        <input type="text" placeholder="학급코드 (영대문자 및 숫자 6자리, 첫 글자는 영문)" value={classCode} onChange={e => handleClassCodeChange(e.target.value)} className="w-full p-3 border rounded-lg" required maxLength="6" />

                        <button type="submit" className="w-full btn-sky py-3">회원가입 및 학급 생성</button>
                    </form>
                    <div className="text-sm text-center mt-6 flex justify-between">
                        <a href="#" onClick={(e) => { e.preventDefault(); onSwitchToLogin(); }} className="font-medium text-sky-600">이미 계정이 있나요?</a>
                        <a href="#" onClick={(e) => { e.preventDefault(); onBack(); }} className="font-medium text-gray-600">뒤로가기</a>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(undefined);
            const [userData, setUserData] = useState(null);
            const [view, setView] = useState('initial');
            const [error, setError] = useState('');
            const [modalState, setModalState] = useState({ isOpen: false });
            useEffect(() => {
                const authUnsub = auth.onAuthStateChanged(async authUser => {
                    if (authUser) {
                        const teacherDoc = await db.collection(CONSTANTS.COLLECTIONS.TEACHERS).doc(authUser.uid).get();
                        if (teacherDoc.exists) { setUser({ uid: authUser.uid, email: authUser.email, role: 'teacher' }); setUserData(teacherDoc.data()); return; }
                        const studentDoc = await db.collection(CONSTANTS.COLLECTIONS.STUDENTS).doc(authUser.uid).get();
                        if (studentDoc.exists) {
                            const studentProfile = studentDoc.data();
                            const classDetails = [];
                            if (studentProfile.classIds && studentProfile.classIds.length > 0) {
                                const classPromises = studentProfile.classIds.map(id => db.collection('classes').doc(id).get());
                                const classDocs = await Promise.all(classPromises);
                                classDocs.forEach(doc => { if (doc.exists) classDetails.push({ id: doc.id, ...doc.data() }); });
                            }
                            setUser({ uid: authUser.uid, email: authUser.email, role: 'student' });
                            setUserData({ ...studentProfile, classDetails });
                            return;
                        }
                        auth.signOut();
                    } else { setUser(null); setUserData(null); setView('initial'); }
                });
                return () => authUnsub();
            }, []);
            const handleLogin = async (id, password, role) => {
                setError('');
                try {
                    let emailToLogin;
                    if (role === 'teacher') { emailToLogin = `${id}@${CONSTANTS.SCHOOL_DOMAIN}`; } 
                    else {
                        const studentQuery = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where("studentId", "==", id);
                        const studentSnapshot = await studentQuery.get();
                        if (studentSnapshot.empty) throw { code: 'auth/user-not-found' };
                        emailToLogin = studentSnapshot.docs[0].data().schoolAccount;
                    }
                    await auth.signInWithEmailAndPassword(emailToLogin, password);
                } catch (err) { setError(mapAuthCodeToMessage(err.code)); }
            };
            
            const handleTeacherSignUp = async (name, accountId, password, className, classCode) => {
                setError('');
                try {
                    const teacherEmail = `${accountId}@${CONSTANTS.SCHOOL_DOMAIN}`;
                    
                    const classCodeQuery = db.collection(CONSTANTS.COLLECTIONS.CLASSES).where("classCode", "==", classCode);
                    const classCodeSnapshot = await classCodeQuery.get();
                    if (!classCodeSnapshot.empty) {
                        setError('이미 사용 중인 학급 코드입니다.');
                        return;
                    }

                    const userCredential = await auth.createUserWithEmailAndPassword(teacherEmail, password);
                    const teacherId = userCredential.user.uid;

                    const batch = db.batch();
                    const teacherRef = db.collection(CONSTANTS.COLLECTIONS.TEACHERS).doc(teacherId);
                    batch.set(teacherRef, { name, email: teacherEmail });

                    const classRef = db.collection(CONSTANTS.COLLECTIONS.CLASSES).doc();
                    batch.set(classRef, { teacherId, className, classCode });

                    await batch.commit();

                    await auth.signOut();
                    setModalState({ 
                        isOpen: true, 
                        title: '회원가입 완료', 
                        content: '교사 회원가입 및 첫 학급 생성이 완료되었습니다. 로그인해주세요.' 
                    });
                    setView('teacherLogin');
                } catch (err) {
                    setError(mapAuthCodeToMessage(err.code));
                }
            };
            
            const handleStudentSignUp = async (name, studentId, password, classCode, schoolAccountId) => {
                setError('');
                if (!/^\d{6,}$/.test(password)) { setError('비밀번호는 숫자 6자리 이상이어야 합니다.'); return; }
                try {
                    const q = db.collection(CONSTANTS.COLLECTIONS.CLASSES).where("classCode", "==", classCode.toUpperCase());
                    const querySnapshot = await q.get();
                    if (querySnapshot.empty) { setError("유효하지 않은 학급 코드입니다."); return; }
                    
                    const classDoc = querySnapshot.docs[0];
                    const studentEmail = `${schoolAccountId}@${CONSTANTS.SCHOOL_DOMAIN}`;

                    const idQuery = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where("studentId", "==", studentId);
                    const idSnapshot = await idQuery.get();
                    if (!idSnapshot.empty) {
                        setError('이미 사용 중인 학번(아이디)입니다.');
                        return;
                    }

                    const accountQuery = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where("schoolAccount", "==", studentEmail);
                    const accountSnapshot = await accountQuery.get();
                    if (!accountSnapshot.empty) {
                        setError('이미 가입된 학교 구글 계정입니다.');
                        return;
                    }

                    const userCredential = await auth.createUserWithEmailAndPassword(studentEmail, password);
                    await db.collection(CONSTANTS.COLLECTIONS.STUDENTS).doc(userCredential.user.uid).set({ 
                        name, 
                        studentId, 
                        schoolAccount: studentEmail, 
                        classIds: [classDoc.id], 
                        approvedBy: { [classDoc.id]: false } 
                    });
                    
                    await auth.signOut();
                    setModalState({ isOpen: true, title: '신청 완료', content: '회원가입 신청이 완료되었습니다. 선생님의 승인 후 학급 활동을 시작할 수 있습니다. 로그인해주세요.' });
                    setView('studentLogin');
                } catch (err) { setError(mapAuthCodeToMessage(err.code)); }
            };

            if (user === undefined) return <div className="min-h-screen flex items-center justify-center text-xl">로딩 중...</div>;
            if (user && userData) { return <Dashboard user={user} initialUserData={userData} onLogout={() => auth.signOut()} />; }
            const InitialScreen = ({ onSelectRole }) => (
                <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-8 text-center">
                    <div className="space-y-4 mt-6">
                        <button onClick={() => onSelectRole('studentLogin')} className="w-full btn-rose py-3">학생</button>
                        <button onClick={() => onSelectRole('teacherLogin')} className="w-full btn-sky py-3">교사</button>
                    </div>
                </div>
            );
            let authView;
            switch (view) {
                case 'teacherLogin': authView = <AuthForm title="교사 로그인" buttonText="로그인" onSubmit={(id, pass) => handleLogin(id, pass, 'teacher')} onSwitchToSignup={() => { setView('teacherSignup'); setError(''); }} onBack={() => { setView('initial'); setError(''); }} isTeacher />; break;
                case 'teacherSignup': authView = <TeacherSignUpForm onSubmit={handleTeacherSignUp} onSwitchToLogin={() => { setView('teacherLogin'); setError(''); }} onBack={() => { setView('initial'); setError(''); }} />; break;
                case 'studentLogin': authView = <AuthForm title="학생 로그인" buttonText="로그인" onSubmit={(id, pass) => handleLogin(id, pass, 'student')} onSwitchToSignup={() => { setView('studentSignup'); setError(''); }} onBack={() => { setView('initial'); setError(''); }} />; break;
                case 'studentSignup': authView = <StudentSignUpForm onSubmit={handleStudentSignUp} onSwitchToLogin={() => { setView('studentLogin'); setError(''); }} onBack={() => { setView('initial'); setError(''); }} />; break;
                default: authView = <InitialScreen onSelectRole={setView} />;
            }
            return (
                <div className="min-h-screen bg-gradient-to-br from-rose-100 to-sky-200 flex flex-col">
                    <main className="flex-grow flex flex-col justify-center items-center p-4">
                        <Modal modalState={modalState} setModalState={setModalState} />
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-bold text-slate-800">기가지현</h1>
                            <p className="text-slate-600 mt-2">스마트한 학급 운영의 시작</p>
                        </div>
                        {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4 w-full max-w-md cursor-pointer" onClick={() => setError('')}>{error}</div>}
                        <div className="w-full max-w-md">{authView}</div>
                    </main>
                    <footer className="text-center py-4"><p className="text-xs text-slate-500">© 2025. 100jihyun@{CONSTANTS.SCHOOL_DOMAIN}</p></footer>
                </div>
            );
        }
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

</html>
