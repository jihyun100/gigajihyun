<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기가지현</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 110px; }
        .calendar-day.other-month { background-color: #f9fafb; color: #d1d5db; }
        @keyframes pulse { 50% { opacity: .5; } }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #e5e7eb; border-radius: 0.5rem; }
        .sidebar { transition: width 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .btn-sky { background-color: #0ea5e9; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: all 0.2s; }
        .btn-sky:hover { background-color: #0284c7; box-shadow: 0 4px 15px -5px rgba(2, 132, 199, 0.6); transform: translateY(-2px); }
        .btn-rose { background-color: #f43f5e; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: all 0.2s; }
        .btn-rose:hover { background-color: #e11d48; box-shadow: 0 4px 15px -5px rgba(225, 29, 72, 0.6); transform: translateY(-2px); }
        .btn-green { background-color: #22c55e; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: all 0.2s; }
        .btn-green:hover { background-color: #16a34a; box-shadow: 0 4px 15px -5px rgba(22, 163, 74, 0.6); transform: translateY(-2px); }
        .btn-gray { background-color: #e5e7eb; color: #374151; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: all 0.2s; }
        .btn-gray:hover { background-color: #d1d5db; }
        .btn-red { background-color: #f43f5e; color: white; font-weight: bold; border-radius: 0.5rem; padding: 0.625rem 1.5rem; transition: all 0.2s; }
        .btn-red:hover { background-color: #e11d48; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef, useReducer } = React;

        // --- 상수 및 Firebase 설정 ---
        const CONSTANTS = {
            SCHOOL_DOMAIN: 'somyong.ms.kr',
            ADMIN_ACCOUNT: '100jihyun@somyong.ms.kr',
            COLLECTIONS: { TEACHERS: 'teachers', STUDENTS: 'students', CLASSES: 'classes', SCORES: 'scores', SCHEDULES: 'schedules', ASSESSMENTS: 'assessments', AUTHORIZED_TEACHERS: 'authorizedTeachers' },
        };

        const firebaseConfig = {
            apiKey: "AIzaSyBXWQs6WSQeno57qZOMyRUWGFsLwG9M7ws",
            authDomain: "gigajihyun.firebaseapp.com",
            projectId: "gigajihyun",
            storageBucket: "gigajihyun.appspot.com",
            messagingSenderId: "28213778220",
            appId: "1:28213778220:web:08c3b3fcd8187a57377e89",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        const mapAuthCodeToMessage = (code) => {
            switch (code) {
                case 'auth/popup-closed-by-user': return '로그인 팝업이 닫혔습니다. 다시 시도해주세요.';
                default: return `오류가 발생했습니다: ${code}`;
            }
        };

        // --- 공용 컴포넌트 ---
        const Modal = ({ modalState, setModalState }) => {
            const { isOpen, title, content, isConfirm, onConfirm, confirmText = '확인', cancelText = '취소', size = 'max-w-lg', confirmButtonClass = 'btn-sky' } = modalState;
            if (!isOpen) return null;
            
            const handleClose = () => setModalState({ isOpen: false });
            
            const handleConfirm = async () => {
                if (onConfirm) {
                    const result = await onConfirm();
                    if (result === false) return;
                }
                handleClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100]" onClick={handleClose}>
                    <div className={`bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full m-4 ${size}`} onClick={e => e.stopPropagation()}>
                        {title && <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">{title}</h3>}
                        <div className="text-gray-600 text-center">{content}</div>
                        <div className={`flex gap-4 mt-6 ${isConfirm ? 'justify-end' : 'justify-center'}`}>
                            {isConfirm && (<button onClick={handleClose} className="btn-gray">{cancelText}</button>)}
                            <button onClick={handleConfirm} className={confirmButtonClass}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const useToast = () => {
            const [toast, setToast] = useState({ message: '', isVisible: false });

            const showToast = (message) => {
                setToast({ message, isVisible: true });
                setTimeout(() => {
                    setToast({ message: '', isVisible: false });
                }, 2500);
            };

            return { toast, showToast };
        };

        const Toast = ({ message, isVisible }) => {
            if (!isVisible) return null;

            const styles = {
                position: 'fixed',
                bottom: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                backgroundColor: 'rgba(0, 0, 0, 0.75)',
                color: 'white',
                padding: '12px 24px',
                borderRadius: '30px',
                zIndex: '1000',
                transition: 'opacity 0.5s, transform 0.5s',
                opacity: isVisible ? 1 : 0,
            };

            return <div style={styles}>{message}</div>;
        };

        const StudentListEditor = ({ title, students, onUpdate, onAdd, onDelete, onLoad, onSave, setModalState }) => {
            const fileInputRef = useRef(null);
            const [isComposing, setIsComposing] = useState(false);
            
            const studentChunks = useMemo(() => {
                const chunkSize = 10;
                const chunks = [];
                const sortedStudents = [...students].sort((a, b) => a.studentId - b.studentId);
                for (let i = 0; i < sortedStudents.length; i += chunkSize) {
                    chunks.push(sortedStudents.slice(i, i + chunkSize));
                }
                return chunks;
            }, [students]);

            const handleDeleteClick = (studentId, studentName) => {
                setModalState({
                    isOpen: true,
                    isConfirm: true,
                    title: "학생 삭제",
                    content: `'${studentName}' 학생을 명단에서 삭제하시겠습니까?`,
                    onConfirm: () => {
                        onDelete(studentId);
                        return true;
                    }
                });
            };
            
            const handleIdUpdate = (id, value) => {
                const newValue = parseInt(value, 10);
                if (isNaN(newValue) || newValue < 1) { setModalState({ isOpen: true, title: '오류', content: '유효하지 않은 번호입니다.' }); return; }
                if (students.some(s => s.studentId === newValue && s.id !== id)) { setModalState({ isOpen: true, title: '오류', content: '이미 사용 중인 번호입니다.' }); return; }
                onUpdate(id, 'studentId', newValue);
            };

            const handleNameChange = (id, value) => {
                if (isComposing) return;
                onUpdate(id, 'name', value);
            };

            return (
                <aside className="mt-8 bg-white p-4 rounded-xl shadow-md flex flex-col">
                    <input type="file" ref={fileInputRef} id="fileLoader" accept=".txt" style={{ display: 'none' }} onChange={onLoad} />
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
                        <div className="flex gap-2">
                            <button onClick={() => fileInputRef.current.click()} className="btn-gray !text-xs !py-1 !px-2">불러오기</button>
                            <button onClick={onSave} className="btn-gray !text-xs !py-1 !px-2">저장하기</button>
                        </div>
                    </div>
                    <div className="overflow-auto border rounded-lg" style={{ maxHeight: '400px' }}>
                        <table className="min-w-full">
                            <thead className="bg-gray-50 sticky top-0">
                                <tr>
                                    <th className="px-3 py-2 text-xs text-center w-20">번호</th>
                                    <th className="px-3 py-2 text-xs text-left">이름</th>
                                    <th className="px-3 py-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {students.sort((a, b) => a.studentId - b.studentId).map(student => (
                                    <tr key={student.id}>
                                        <td className="px-3 py-1 text-center">
                                            <input type="number" defaultValue={student.studentId} onBlur={e => handleIdUpdate(student.id, e.target.value)} className="w-full text-center bg-transparent rounded focus:bg-yellow-50 outline-none" />
                                        </td>
                                        <td className="px-3 py-1">
                                            <input type="text" key={student.name} defaultValue={student.name} className="w-full bg-transparent rounded focus:bg-yellow-50 outline-none"
                                                onCompositionStart={() => setIsComposing(true)}
                                                onCompositionEnd={(e) => { setIsComposing(false); handleNameChange(student.id, e.target.value); }}
                                                onChange={(e) => handleNameChange(student.id, e.target.value)}
                                                onBlur={(e) => handleNameChange(student.id, e.target.value)}
                                            />
                                        </td>
                                        <td className="px-3 py-1 text-center">
                                            <button onClick={() => handleDeleteClick(student.id, student.name)} className="text-red-500 hover:text-red-700 p-1 rounded-full">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <button onClick={onAdd} className="w-full text-xl text-blue-500 hover:bg-blue-100 font-bold p-1 rounded-lg mt-2">+</button>
                </aside>
            );
        };
        
        // --- 학생 정보 동기화 컴포넌트 ---
        const StudentSync = ({ setModalState }) => {
            const [sheetUrl, setSheetUrl] = useState('');
            const [selectedGrade, setSelectedGrade] = useState('');
            const [loading, setLoading] = useState(false);

            const extractSheetId = (url) => {
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            };

            const handleSync = async () => {
                const sheetId = extractSheetId(sheetUrl);
                if (!sheetId) {
                    setModalState({ isOpen: true, title: 'URL 오류', content: '유효한 Google Sheets URL을 입력해주세요.' });
                    return;
                }
                if (!selectedGrade) {
                    setModalState({ isOpen: true, title: '학년 미선택', content: '동기화할 학년을 선택해주세요.' });
                    return;
                }

                setLoading(true);
                setModalState({ isOpen: true, title: '동기화 진행 중', content: `시트에서 '${selectedGrade}' 탭 데이터를 불러오고 있습니다...`, isConfirm: false });

                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${selectedGrade}`;

                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`'${selectedGrade}' 시트 정보를 불러올 수 없습니다. 시트 이름과 공유 설정을 확인해주세요.`);
                    
                    const text = await res.text();
                    const jsonString = text.substring(47).slice(0, -2);
                    const json = JSON.parse(jsonString);

                    if (json.status === 'error' || !json.table?.rows?.length) {
                        throw new Error(`'${selectedGrade}' 시트가 비어있거나 데이터 형식이 올바르지 않습니다.`);
                    }

                    const studentDataFromSheet = json.table.rows.map(row => ({
                        studentId: row.c[0]?.v,
                        name: row.c[1]?.v,
                        schoolAccount: row.c[2]?.v,
                    })).filter(s => s.studentId && s.name && s.schoolAccount);
                    
                    if (studentDataFromSheet.length === 0) {
                        throw new Error('시트에서 유효한 학생 데이터를 찾을 수 없습니다. A열(학번), B열(이름), C열(구글계정) 형식을 확인해주세요.');
                    }
                    
                    setModalState({ isOpen: true, title: '동기화 진행 중', content: `${studentDataFromSheet.length}명의 학생 정보를 DB와 대조합니다...`, isConfirm: false });

                    const batch = db.batch();
                    let updatedCount = 0;
                    let notFoundAccounts = [];

                    for (const sheetStudent of studentDataFromSheet) {
                        const studentQuery = await db.collection('students').where('schoolAccount', '==', sheetStudent.schoolAccount).limit(1).get();
                        
                        if (!studentQuery.empty) {
                            const studentDoc = studentQuery.docs[0];
                            batch.update(studentDoc.ref, {
                                studentId: sheetStudent.studentId.toString(),
                                name: sheetStudent.name
                            });
                            updatedCount++;
                        } else {
                            notFoundAccounts.push(sheetStudent.schoolAccount);
                        }
                    }

                    await batch.commit();
                    
                    let resultMessage = `총 ${updatedCount}명의 학생 정보(학번, 이름)가 성공적으로 업데이트되었습니다.`;
                    if(notFoundAccounts.length > 0) {
                        resultMessage += `\n\nDB에서 다음 계정을 찾지 못했습니다: ${notFoundAccounts.join(', ')}`;
                    }

                    setModalState({ 
                        isOpen: true, 
                        title: '동기화 완료', 
                        content: <div className="whitespace-pre-wrap">{resultMessage}</div>
                    });

                } catch (err) {
                    setModalState({ isOpen: true, title: '동기화 실패', content: err.message });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-8 rounded-lg shadow-md">
                    <h3 className="text-xl font-bold text-gray-700 mb-2">학생 정보 동기화 (관리자)</h3>
                    <p className="text-gray-500 mb-4">
                        학생 정보가 담긴 Google Sheet URL과 동기화 할 학년을 선택하세요. </p>
                    <p className="text-sm text-gray-500 mb-4">시트는 **A열: 학번, B열: 이름, C열: 학교 Google 계정** 순서로 구성되어야 합니다.</p>
                    <div className="grid md:grid-cols-3 gap-2 items-end">
                        <div className="md:col-span-2">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Google Sheets URL</label>
                            <input
                                type="text"
                                value={sheetUrl}
                                onChange={e => setSheetUrl(e.target.value)}
                                className="w-full p-2 border rounded-md"
                                placeholder="Google Sheets URL 붙여넣기"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">학년 선택 (시트 탭 이름)</label>
                            <select value={selectedGrade} onChange={e => setSelectedGrade(e.target.value)} className="w-full p-2 border rounded-md">
                                <option value="">-- 학년 선택 --</option>
                                <option value="1학년">1학년</option>
                                <option value="2학년">2학년</option>
                                <option value="3학년">3학년</option>
                            </select>
                        </div>
                    </div>
                        <div className="mt-4">
                            <button onClick={handleSync} disabled={loading} className="w-full btn-sky !px-4 !py-2">
                                {loading ? '동기화 중...' : '동기화 실행'}
                            </button>
                        </div>
                    <p className="text-xs text-red-500 mt-2">* 주의: 시트의 공유 설정이 '링크가 있는 모든 사용자가 볼 수 있음'으로 되어 있어야 합니다.</p>
                </div>
            );
        };
        
        const UserInfo = ({ user, userData, setModalState, showToast }) => {
            const [classCode, setClassCode] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleJoinClass = async () => {
                if (classCode.length !== 6) {
                    setModalState({ isOpen: true, title: '입력 오류', content: '학급 코드는 6자리여야 합니다.' });
                    return;
                }
                setIsLoading(true);
                try {
                    const classSnap = await db.collection('classes').where('classCode', '==', classCode.toUpperCase()).get();
                    if (classSnap.empty) {
                        setModalState({ isOpen: true, title: '오류', content: '존재하지 않는 학급 코드입니다.' });
                        setIsLoading(false); return;
                    }
                    const classId = classSnap.docs[0].id;
                    if (userData.classIds?.includes(classId)) {
                        setModalState({ isOpen: true, title: '오류', content: '이미 가입 신청했거나 소속된 학급입니다.' });
                        setIsLoading(false); return;
                    }
                    await db.collection('students').doc(user.uid).update({
                        classIds: FieldValue.arrayUnion(classId),
                        [`approvedBy.${classId}`]: false
                    });
                    setModalState({ isOpen: true, title: '성공', content: '가입 요청이 전송되었습니다. 교사의 승인을 기다려주세요.' });
                    setClassCode('');
                } catch (e) {
                    console.error("Error joining class: ", e);
                    setModalState({ isOpen: true, title: '오류', content: '학급 가입 요청에 실패했습니다.' });
                }
                setIsLoading(false);
            };

            return (
                <div className="max-w-xl mx-auto space-y-8">
                    <div className="bg-white rounded-xl shadow-md p-8 text-center">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800">{userData.name}</h3>
                        <p className="text-gray-600">{userData.schoolAccount}</p>
                        {userData.studentId && <p className="text-gray-600 mt-2">학번: {userData.studentId}</p>}
                        <p className="mt-6 text-sm text-gray-500">계정 정보는 Google 계정에 따라 관리됩니다.</p>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-md p-8">
                        <h3 className="text-xl font-bold mb-4 text-gray-800">새 학급 가입</h3>
                        <div className="flex gap-2">
                            <input type="text" className="flex-1 p-2 border rounded-lg uppercase" placeholder="학급코드 (6자리)" value={classCode} onChange={e => setClassCode(e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, ''))} maxLength={6} />
                            <button type="button" className="btn-rose !px-4 !py-2" onClick={handleJoinClass} disabled={isLoading}>{isLoading ? '신청중...' : '신청'}</button>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">* 새로운 학급에 참여하려면 교사의 승인이 필요합니다.</p>
                    </div>
                </div>
            );
        };
        
        // --- 대시보드 관련 컴포넌트들 ---
        const StudentSelector = ({ currentClassStudents, selectedStudents, onStudentToggle, onSelectAll, onClearAll }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [isSearching, setIsSearching] = useState(false);
            const [searchResults, setSearchResults] = useState([]);

            const handleSearch = async () => {
                if (!searchTerm.trim()) {
                    setSearchResults([]);
                    return;
                }
                setIsSearching(true);
                const nameQuery = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where('name', '>=', searchTerm).where('name', '<=', searchTerm + '\uf8ff').get();
                const idQuery = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where('studentId', '==', searchTerm).get();
                const [nameSnapshot, idSnapshot] = await Promise.all([nameQuery, idQuery]);
                const resultsMap = new Map();
                nameSnapshot.docs.forEach(doc => resultsMap.set(doc.id, { id: doc.id, ...doc.data() }));
                idSnapshot.docs.forEach(doc => resultsMap.set(doc.id, { id: doc.id, ...doc.data() }));
                setSearchResults(Array.from(resultsMap.values()));
                setIsSearching(false);
            };

            const studentsToList = searchTerm ? searchResults : currentClassStudents;
            const isAllSelected = currentClassStudents.length > 0 && currentClassStudents.every(s => selectedStudents.some(ss => ss.id === s.id));

            return (
                <div className="w-full md:w-80 bg-gray-50 p-4 border-t md:border-t-0 md:border-l flex flex-col rounded-b-2xl md:rounded-r-2xl md:rounded-bl-none">
                    <div className="flex gap-2 mb-4">
                        <input type="text" placeholder="전체 학생 검색 (이름/학번)" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()} className="w-full p-2 border rounded-md" />
                        <button onClick={handleSearch} className="btn-sky flex-shrink-0 !px-4 !py-2">검색</button>
                    </div>
                    <div className="flex items-center justify-between mb-2">
                        <label className="flex items-center gap-2 text-sm">
                            <input type="checkbox" checked={isAllSelected} onChange={() => isAllSelected ? onClearAll() : onSelectAll()} className="h-4 w-4 rounded"/>
                            학급 학생 모두 선택
                        </label>
                    </div>
                    <div className="flex-grow overflow-y-auto border-y py-2 mb-4">
                        {searchTerm && <h5 className="p-2 text-sm font-bold text-gray-600 bg-gray-100 sticky top-0">전체 학생 검색 결과</h5>}
                        {isSearching && <p className="text-center p-4">검색 중...</p>}
                        {[...studentsToList].sort((a, b) => String(a.studentId).localeCompare(String(b.studentId))).map(student => (
                            <div key={student.id} className="flex items-center gap-2 p-2 hover:bg-gray-200 rounded-md">
                                <input type="checkbox" id={`student-${student.id}`} checked={selectedStudents.some(s => s.id === student.id)} onChange={() => onStudentToggle(student)} className="h-4 w-4 rounded" />
                                <label htmlFor={`student-${student.id}`} className="flex-grow">{student.name} ({student.studentId})</label>
                            </div>
                        ))}
                    </div>
                    <div className="flex-shrink-0">
                        <h4 className="font-bold mb-2">선택된 학생 ({selectedStudents.length}명)</h4>
                        <div className="h-32 overflow-y-auto bg-white p-2 border rounded-md text-sm space-y-1">
                            {[...selectedStudents].sort((a, b) => String(a.studentId).localeCompare(String(b.studentId))).map(s => 
                                <div key={s.id} className="flex justify-between items-center bg-sky-50 p-1 rounded">
                                    <span>{s.name} ({s.studentId})</span>
                                    <button onClick={() => onStudentToggle(s)} className="text-red-400 hover:text-red-600 font-bold text-lg leading-none">&times;</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ScheduleFormModal = ({ isOpen, onClose, onSubmit, initialData, currentClassStudents, setModalState }) => {
            const [schedule, setSchedule] = useState(initialData);
            const [isStudentSelectorOpen, setIsStudentSelectorOpen] = useState(false);

            useEffect(() => {
                setSchedule({ title: '', description: '', date: '', time: '', applyToAll: false, relatedStudents: [], ...initialData });
                if (!isOpen) setIsStudentSelectorOpen(false);
            }, [isOpen, initialData]);

            if (!isOpen) return null;

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setSchedule(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handleStudentToggle = (student) => {
                setSchedule(prev => {
                    const isSelected = prev.relatedStudents.some(s => s.id === student.id);
                    return { ...prev, relatedStudents: isSelected ? prev.relatedStudents.filter(s => s.id !== student.id) : [...prev.relatedStudents, student] };
                });
            };
            
            const handleSelectAll = () => {
                const newStudents = currentClassStudents.filter(cs => !schedule.relatedStudents.some(ss => ss.id === cs.id));
                setSchedule(prev => ({...prev, relatedStudents: [...prev.relatedStudents, ...newStudents]}));
            };

            const handleClearAll = () => {
                setSchedule(prev => ({...prev, relatedStudents: prev.relatedStudents.filter(ss => !currentClassStudents.some(cs => cs.id === ss.id))}));
            };
            
            const handleSubmit = () => {
                if(!schedule.title.trim() || !schedule.date) {
                    setModalState({ isOpen: true, title: "입력 오류", content: "제목과 날짜는 필수 항목입니다."});
                    return;
                }
                onSubmit(schedule);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div 
                        className="bg-white rounded-2xl shadow-xl flex flex-col w-full max-w-lg md:max-w-none md:w-auto max-h-[90vh] overflow-y-auto" 
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex flex-col md:flex-row">
                            <div className="p-8 w-full md:w-[500px] flex-shrink-0">
                                <h3 className="text-xl font-bold text-gray-800 mb-6 text-center">{schedule.id ? "일정 수정" : "일정 추가"}</h3>
                                <div className="space-y-4">
                                    <input type="text" name="title" placeholder="제목" value={schedule.title} onChange={handleChange} className="w-full p-3 border rounded-lg" required />
                                    <textarea name="description" placeholder="설명" value={schedule.description} onChange={handleChange} className="w-full p-3 border rounded-lg h-24" />
                                    <div className="flex gap-4">
                                        <input type="date" name="date" value={schedule.date} onChange={handleChange} className="w-full p-3 border rounded-lg" required />
                                        <input type="time" name="time" value={schedule.time} onChange={handleChange} className="w-full p-3 border rounded-lg" />
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <label className="flex items-center gap-2">
                                            <input type="checkbox" name="applyToAll" checked={schedule.applyToAll} onChange={handleChange} className="h-4 w-4"/>
                                            나의 모든 학급에 적용
                                        </label>
                                        <button onClick={() => setIsStudentSelectorOpen(prev => !prev)} className="btn-gray !px-4 !py-2">
                                            {isStudentSelectorOpen ? '학생선택 닫기' : '학생 선택'}
                                        </button>
                                    </div>
                                </div>
                                <div className="flex gap-4 mt-8 justify-end">
                                    <button onClick={onClose} className="btn-gray">취소</button>
                                    <button onClick={handleSubmit} className="btn-sky">{schedule.id ? "수정" : "저장"}</button>
                                </div>
                            </div>
                            {isStudentSelectorOpen && <StudentSelector currentClassStudents={currentClassStudents} selectedStudents={schedule.relatedStudents} onStudentToggle={handleStudentToggle} onSelectAll={handleSelectAll} onClearAll={handleClearAll} />}
                        </div>
                    </div>
                </div>
            );
        };

        const ScheduleDetailModal = ({ isOpen, onClose, schedule, onEdit, onDelete, isTeacher }) => {
            if(!isOpen || !schedule) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">{schedule.title}</h3>
                        <p className="text-gray-500 mb-4">{schedule.date} {schedule.time}</p>
                        <p className="bg-gray-50 p-4 rounded-md mb-4 min-h-[100px] whitespace-pre-wrap">{schedule.description || "상세 설명이 없습니다."}</p>
                        <h4 className="font-bold mb-2">관련 학생</h4>
                        <div className="bg-gray-50 p-4 rounded-md mb-6 text-sm">
                            {schedule.relatedStudents && schedule.relatedStudents.length > 0 ? 
                                [...schedule.relatedStudents].sort((a, b) => String(a.studentId).localeCompare(String(b.studentId))).map(s => <span key={s.id} className="inline-block bg-sky-100 text-sky-800 px-2 py-1 rounded-full mr-2 mb-2">{s.name} ({s.studentId})</span>) :
                                "이 학급의 모든 학생에게 적용됩니다."
                            }
                        </div>
                        <div className="flex gap-4 mt-8 justify-end">
                            <button onClick={onClose} className="btn-gray">닫기</button>
                            {isTeacher && (
                                <>
                                    <button onClick={() => { onClose(); onEdit(schedule); }} className="btn-sky">수정</button>
                                    <button onClick={() => { onClose(); onDelete(schedule); }} className="btn-red">삭제</button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            )
        };

        const ScheduleCalendar = ({ classes, selectedClass, selectedClassId, students, teacherId, isTeacher, setModalState: setAppModalState, showToast }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [schedules, setSchedules] = useState([]);
            const [modalState, setModalState] = useState({ formOpen: false, detailOpen: false, initialData: null });
            const [classNotice, setClassNotice] = useState('');

            useEffect(() => {
                if (selectedClass) {
                    setClassNotice(selectedClass.classNotice || '');
                }
            }, [selectedClass]);

            useEffect(() => {
                if (!selectedClassId) return;
                const unsubscribe = db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(selectedClassId).onSnapshot(doc => {
                    setSchedules(doc.exists ? doc.data().events || [] : []);
                });
                return () => unsubscribe();
            }, [selectedClassId]);
            
            const handleNoticeSave = async () => {
                if (!selectedClassId) return;
                try {
                    await db.collection('classes').doc(selectedClassId).update({ classNotice: classNotice });
                    showToast("공지사항이 저장되었습니다."); // 변경 코드
                } catch (error) {
                    console.error("공지사항 저장 실패:", error);
                    setAppModalState({isOpen: true, title: "오류", content: "공지사항 저장에 실패했습니다."});
                }
            };

            const startDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

            const handleAddClick = (dateStr) => {
                if (isTeacher) setModalState({ formOpen: true, detailOpen: false, initialData: { date: dateStr, relatedStudents: [] } });
            };
            const handleEditClick = (schedule) => setModalState({ formOpen: true, detailOpen: false, initialData: schedule });
            const handleScheduleClick = (schedule) => setModalState({ formOpen: false, detailOpen: true, initialData: schedule });
            
            const handleFormSubmit = async (scheduleData) => {
                const { id, ...restData } = scheduleData;
                const scheduleId = id || `sched_${Date.now()}`;
                const newSchedulePayload = { 
                    ...restData, 
                    id: scheduleId, 
                    relatedStudents: scheduleData.relatedStudents.map(s => ({id: s.id, name: s.name, studentId: s.studentId})), 
                    authorId: teacherId 
                };

                const classIdsToUpdate = scheduleData.applyToAll ? classes.map(c => c.id) : [selectedClassId];
                
                const batch = db.batch();

                const scheduleDocs = await Promise.all(
                    classIdsToUpdate.map(id => db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(id).get())
                );

                scheduleDocs.forEach((doc, index) => {
                    const classId = classIdsToUpdate[index];
                    const classScheduleRef = db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(classId);
                    
                    const existingEvents = doc.exists ? doc.data().events || [] : [];
                    let newEvents;

                    if (id) {
                        const eventIndex = existingEvents.findIndex(event => event.id === id);
                        if (eventIndex > -1) {
                            existingEvents[eventIndex] = newSchedulePayload;
                            newEvents = existingEvents;
                        } else {
                            newEvents = [...existingEvents, newSchedulePayload];
                        }
                    } else {
                        newEvents = [...existingEvents, newSchedulePayload];
                    }
                    
                    batch.set(classScheduleRef, { events: newEvents }, { merge: true });
                });

                try {
                    await batch.commit();
                } catch (error) {
                    console.error("일정 저장 실패:", error);
                    setAppModalState({ isOpen: true, title: "오류", content: `일정 저장에 실패했습니다. Firestore 보안 규칙을 확인해주세요.` });
                }
            };

            const handleDeleteRequest = (scheduleToDelete) => {
                const confirmContent = scheduleToDelete.applyToAll
                    ? `'${scheduleToDelete.title}' 일정을 나의 모든 학급에서 삭제합니다. 정말 삭제하시겠습니까?`
                    : `'${scheduleToDelete.title}' 일정을 정말 삭제하시겠습니까?`;

                setAppModalState({
                    isOpen: true,
                    title: "삭제 확인",
                    content: confirmContent,
                    isConfirm: true,
                    onConfirm: () => handleDeleteSchedule(scheduleToDelete)
                });
            };

            const handleDeleteSchedule = async (scheduleToDelete) => {
                const classIdsToUpdate = scheduleToDelete.applyToAll ? classes.map(c => c.id) : [selectedClassId];
                
                const batch = db.batch();

                const scheduleDocs = await Promise.all(
                    classIdsToUpdate.map(id => db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(id).get())
                );

                scheduleDocs.forEach((doc, index) => {
                    if (doc.exists) {
                        const classId = classIdsToUpdate[index];
                        const docRef = db.collection(CONSTANTS.COLLECTIONS.SCHEDULES).doc(classId);
                        const existingEvents = doc.data().events || [];
                        const newEvents = existingEvents.filter(event => event.id !== scheduleToDelete.id);
                        batch.update(docRef, { events: newEvents });
                    }
                });

                try {
                    await batch.commit();
                } catch (error) {
                    console.error("일정 삭제 실패:", error);
                    setAppModalState({ isOpen: true, title: "오류", content: "일정 삭제 중 오류가 발생했습니다." });
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    {isTeacher && <ScheduleFormModal isOpen={modalState.formOpen} onClose={() => setModalState({ formOpen: false, detailOpen: false, initialData: null })} onSubmit={handleFormSubmit} initialData={modalState.initialData} currentClassStudents={students} setModalState={setAppModalState} />}
                    <ScheduleDetailModal isOpen={modalState.detailOpen} onClose={() => setModalState({ formOpen: false, detailOpen: false, initialData: null })} schedule={modalState.initialData} onEdit={handleEditClick} onDelete={handleDeleteRequest} isTeacher={isTeacher}/>
                    
                    <div className="mb-4">
                        {isTeacher ? (
                            <div className="flex items-center gap-2">
                                <input 
                                    type="text"
                                    value={classNotice}
                                    onChange={(e) => setClassNotice(e.target.value)}
                                    placeholder="학급 공지사항을 입력하세요..."
                                    className="w-full p-2 border rounded-md"
                                />
                                <button onClick={handleNoticeSave} className="btn-sky !px-4 !py-2 flex-shrink-0">저장</button>
                            </div>
                        ) : (
                            <div className="p-3 bg-sky-50 text-sky-800 rounded-md text-center">
                                <p>{selectedClass?.classNotice || '등록된 공지사항이 없습니다.'}</p>
                            </div>
                        )}
                    </div>

                    <div className="flex justify-center items-center gap-4 mb-4">
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 text-gray-500 bg-white border shadow-sm rounded-full hover:bg-gray-100 active:scale-95 transition">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 className="text-2xl font-bold">{currentDate.getFullYear()}년 {currentDate.getMonth() + 1}월</h3>
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 text-gray-500 bg-white border shadow-sm rounded-full hover:bg-gray-100 active:scale-95 transition">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div className="calendar-grid border-t border-l">
                        {['일', '월', '화', '수', '목', '금', '토'].map(day => <div key={day} className="text-center font-bold p-3 bg-gray-50 border-b border-r">{day}</div>)}
                        {Array.from({ length: startDay }).map((_, i) => <div key={`empty-${i}`} className="calendar-day border-b border-r other-month"></div>)}
                        {Array.from({ length: daysInMonth }).map((_, i) => {
                            const day = i + 1;
                            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const daySchedules = schedules.filter(s => s.date === dateStr);
                            const dayOfWeek = date.getDay();

                            return (
                                <div key={day} className={`calendar-day border-b border-r p-2 flex flex-col ${isTeacher ? 'cursor-pointer hover:bg-sky-50' : ''} transition-colors duration-200`} onClick={() => handleAddClick(dateStr)}>
                                    <span className={`font-bold ${dayOfWeek === 0 ? 'text-red-500' : ''} ${dayOfWeek === 6 ? 'text-blue-500' : ''}`}>{day}</span>
                                    <div className="flex-grow mt-1 space-y-1 overflow-y-auto">
                                    {daySchedules.map((s) => (
                                        <div key={s.id} onClick={(e) => { e.stopPropagation(); handleScheduleClick(s);}} className="bg-sky-100 text-sky-800 text-xs p-1 rounded-md hover:bg-sky-200 cursor-pointer">
                                            <p className="font-bold truncate">{s.title}</p>
                                        </div>
                                    ))}
                                    </div>
                                </div>
                            );
                        })}
                        {Array.from({ length: (7 - (daysInMonth + startDay) % 7) % 7 }).map((_, i) => <div key={`empty-end-${i}`} className="calendar-day border-b border-r other-month"></div>)}
                    </div>
                </div>
            );
        };
        
        const InviteStudentModal = ({ isOpen, onClose, student, classes, onInvite }) => {
            const [targetClassId, setTargetClassId] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setTargetClassId('');
                }
            }, [isOpen]);

            if (!isOpen || !student) return null;

            const invitableClasses = classes.filter(c => !student.classIds.includes(c.id));

            const handleInvite = () => {
                if (!targetClassId) {
                    alert('초대할 학급을 선택해주세요.');
                    return;
                }
                onInvite(student, targetClassId);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">학급 초대</h3>
                        <p className="text-center text-gray-600 mb-6">
                            <span className="font-bold">{student.name}</span> 학생을 초대할 학급을 선택하세요.
                        </p>
                        <div className="space-y-4">
                            {invitableClasses.length > 0 ? (
                                <select
                                    value={targetClassId}
                                    onChange={e => setTargetClassId(e.target.value)}
                                    className="w-full mt-1 p-2 border rounded-md"
                                >
                                    <option value="">-- 학급 선택 --</option>
                                    {invitableClasses.map(c => (
                                        <option key={c.id} value={c.id}>{c.className}</option>
                                    ))}
                                </select>
                            ) : (
                                <p className="text-center text-gray-500 bg-gray-100 p-4 rounded-md">초대할 수 있는 다른 학급이 없습니다.</p>
                            )}
                        </div>
                        <div className="flex gap-4 mt-8 justify-end">
                            <button onClick={onClose} className="btn-gray">취소</button>
                            <button onClick={handleInvite} disabled={!targetClassId || invitableClasses.length === 0} className="btn-green">초대하기</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const EditClassModal = ({ isOpen, onClose, classItem, onSave }) => {
            if (!isOpen) return null;

            const [className, setClassName] = useState(classItem.className);

            const handleSave = async () => {
                if (!className.trim()) {
                    alert('학급 이름은 비워둘 수 없습니다.');
                    return;
                }
                await onSave(classItem.id, { className });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">학급 이름 수정</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">학급 이름</label>
                                <input type="text" value={className} onChange={e => setClassName(e.target.value)} className="w-full mt-1 p-2 border rounded-md" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">학급 코드 (변경 불가)</label>
                                <input type="text" value={classItem.classCode} disabled className="w-full mt-1 p-2 border rounded-md bg-gray-100" />
                            </div>
                        </div>
                        <div className="flex gap-4 mt-8 justify-end">
                            <button onClick={onClose} className="btn-gray">취소</button>
                            <button onClick={handleSave} className="btn-sky">저장</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const TeacherWhitelistManager = ({ setModalState }) => {
            const [authorizedTeachers, setAuthorizedTeachers] = useState([]);
            const [newTeacherEmail, setNewTeacherEmail] = useState('');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsub = db.collection(CONSTANTS.COLLECTIONS.AUTHORIZED_TEACHERS).onSnapshot(snapshot => {
                    const teacherList = snapshot.docs.map(doc => ({ email: doc.id, ...doc.data() }));
                    setAuthorizedTeachers(teacherList);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const handleAddTeacher = async () => {
                const email = newTeacherEmail.trim().toLowerCase();
                if (!email) {
                    setModalState({ isOpen: true, title: '입력 오류', content: '이메일을 입력해주세요.' });
                    return;
                }
                if (!email.endsWith(`@${CONSTANTS.SCHOOL_DOMAIN}`)) {
                    setModalState({ isOpen: true, title: '입력 오류', content: `'${CONSTANTS.SCHOOL_DOMAIN}' 도메인 이메일만 추가할 수 있습니다.` });
                    return;
                }

                try {
                    await db.collection(CONSTANTS.COLLECTIONS.AUTHORIZED_TEACHERS).doc(email).set({
                        addedAt: FieldValue.serverTimestamp(),
                        addedBy: auth.currentUser.email,
                    });
                    setNewTeacherEmail('');
                    setModalState({ isOpen: true, title: '성공', content: `'${email}' 계정을 교사로 승인했습니다.` });
                } catch (error) {
                    setModalState({ isOpen: true, title: '오류', content: `계정 추가에 실패했습니다: ${error.message}` });
                }
            };
            
            const handleDeleteTeacher = (email) => {
                setModalState({
                    isOpen: true, isConfirm: true, title: '삭제 확인',
                    content: `정말로 '${email}' 계정을 교사 승인 목록에서 삭제하시겠습니까?`,
                    onConfirm: async () => {
                        try {
                            await db.collection(CONSTANTS.COLLECTIONS.AUTHORIZED_TEACHERS).doc(email).delete();
                            setModalState({ isOpen: true, title: '성공', content: '계정이 삭제되었습니다.' });
                            return true;
                        } catch (error) {
                             setModalState({ isOpen: true, title: '오류', content: `삭제에 실패했습니다: ${error.message}` });
                             return false;
                        }
                    }
                });
            };

            return (
                 <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-xl font-bold mb-4">교사 계정 관리 (관리자)</h3>
                    <p className="text-gray-500 mb-4 text-sm">
                        여기에 등록된 학교 Google 계정만 '교사'로 가입 및 로그인이 가능합니다.
                    </p>
                    <div className="flex flex-col md:flex-row gap-4 items-end mb-6">
                        <div className="flex-1 w-full">
                            <label className="text-sm font-medium text-gray-600">추가할 교사 이메일</label>
                            <input 
                                type="email" 
                                value={newTeacherEmail} 
                                onChange={e => setNewTeacherEmail(e.target.value)} 
                                placeholder={`teacher@${CONSTANTS.SCHOOL_DOMAIN}`} 
                                className="w-full mt-1 p-2 border rounded-md" 
                            />
                        </div>
                        <button onClick={handleAddTeacher} className="btn-green w-full md:w-auto !px-6 !py-2">추가</button>
                    </div>
                    
                    <h4 className="font-bold text-gray-700 mb-2">승인된 교사 목록</h4>
                    {loading ? <p>로딩 중...</p> : (
                        <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                             {authorizedTeachers.map(teacher => (
                                <div key={teacher.email} className="p-3 bg-gray-50 rounded-md flex justify-between items-center">
                                    <span>{teacher.email}</span>
                                    <button onClick={() => handleDeleteTeacher(teacher.email)} className="bg-red-100 hover:bg-red-200 text-red-700 text-xs font-bold py-1 px-3 rounded-md">삭제</button>
                                </div>
                            ))}
                            {authorizedTeachers.length === 0 && <p className="text-gray-500 text-center py-4">승인된 교사 계정이 없습니다.</p>}
                        </div>
                    )}
                </div>
            );
        };
        
        const ClassManagement = ({ teacherId, classes, setModalState, onUpdateClass, onDeleteClass, isAdmin, showToast }) => {
            const [className, setClassName] = useState('');
            const [classCode, setClassCode] = useState('');
            const [editingClass, setEditingClass] = useState(null);

            const handleAddClass = async (e) => {
                e.preventDefault();
                if (!className.trim() || classCode.length !== 6) { setModalState({ isOpen: true, title: '입력 오류', content: '학급명과 6자리 학급코드를 모두 올바르게 입력해주세요.' }); return; }
                const codeExistsQuery = db.collection(CONSTANTS.COLLECTIONS.CLASSES).where('classCode', '==', classCode);
                const codeExistsSnapshot = await codeExistsQuery.get();
                if (!codeExistsSnapshot.empty) { setModalState({ isOpen: true, title: '오류', content: '이미 사용 중인 학급 코드입니다.' }); return; }
                await db.collection(CONSTANTS.COLLECTIONS.CLASSES).add({ teacherId, className, classCode });
                setModalState({ isOpen: true, title: '성공', content: '새로운 학급이 생성되었습니다.' });
                setClassName(''); setClassCode('');
            };
            
            const handleEditClick = (classItem) => {
                setEditingClass(classItem);
            };

            const handleClassCodeChange = (value) => {
                const upperValue = value.toUpperCase();
                let filteredValue = '';
                if (upperValue.length > 0) {
                    const firstChar = upperValue.substring(0, 1).replace(/[^A-Z]/g, '');
                    const restChars = upperValue.substring(1).replace(/[^A-Z0-9]/g, '');
                    filteredValue = firstChar + restChars;
                }
                setClassCode(filteredValue);
            };
            
            return (
                <div>
                    {editingClass && (
                        <EditClassModal
                            isOpen={!!editingClass}
                            onClose={() => setEditingClass(null)}
                            classItem={editingClass}
                            onSave={onUpdateClass}
                        />
                    )}
                    <h2 className="text-3xl font-bold mb-6 text-gray-800">☆  학급 관리</h2>
                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-bold mb-4">새 학급 추가</h3>
                        <form onSubmit={handleAddClass} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full"><label className="text-sm font-medium text-red-600">학급명 ('학년, 반' 숫자가 순서대로 들어가도록 설정하세요!! '시험 점수' 기능 구글시트 특정 탭 호출에 필요.)</label><input type="text" value={className} onChange={e => setClassName(e.target.value)} placeholder="예시: 2학년1반 기가, 1귀염둥이 3반, 체육3-2, 수학24 등 - '학년, 반' 숫자가 순서대로 들어가도록 지정" className="w-full mt-1 p-2 border rounded-md" /></div>
                            <div className="flex-1 w-full"><label className="text-sm font-medium text-gray-600">학급 코드 (6자리, 첫 글자는 영문) 추후 수정 불가함!</label><input type="text" value={classCode} onChange={e => handleClassCodeChange(e.target.value)} maxLength={6} placeholder="예: A12345" className="w-full mt-1 p-2 border rounded-md" /></div>
                            <button type="submit" className="btn-sky w-full md:w-auto !px-6 !py-2">추가</button>
                        </form>
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h3 className="text-xl font-bold mb-4">내 학급 목록</h3>
                        <p className="text-sm text-gray-500 mb-4">내가 개설한 모든 학급의 이름과 학급코드가 표시됩니다.</p>
                        <div className="space-y-2">
                            {classes.map(c => (
                                <div key={c.id} className="p-3 bg-gray-50 rounded-md flex justify-between items-center">
                                    <div>
                                        <span>{c.className}</span>
                                        <span className="ml-4 font-mono bg-gray-200 px-2 py-1 rounded text-sm">{c.classCode}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => handleEditClick(c)} className="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-md">수정</button>
                                        <button onClick={() => onDeleteClass(c)} className="bg-red-100 hover:bg-red-200 text-red-700 text-xs font-bold py-1 px-3 rounded-md">삭제</button>                                    </div>
                                </div>
                            ))}
                            {classes.length === 0 && <p className="text-gray-500 text-center py-4">생성된 학급이 없습니다.</p>}
                        </div>
                    </div>
                    
                    {isAdmin && (
                        <div className="mt-8 space-y-8">
                            <TeacherWhitelistManager setModalState={setModalState} />
                            <StudentSync setModalState={setModalState} />
                        </div>
                    )}
                </div>
            );
        };

        const StudentManagement = ({ students, pendingStudents, deleteStudent, approveStudent, rejectStudent, inviteStudent, classes, setModalState, selectedClass, showToast }) => {
            const [invitingStudent, setInvitingStudent] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isSearching, setIsSearching] = useState(false);
            const [searchResults, setSearchResults] = useState([]);

            const handleSearch = async () => {
                if (!searchTerm.trim()) {
                    setSearchResults([]);
                    return;
                }
                setIsSearching(true);
                try {
                    const nameQuery = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where('name', '>=', searchTerm).where('name', '<=', searchTerm + '\uf8ff').get();
                    const idQuery = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where('studentId', '==', searchTerm).get();
                    const [nameSnapshot, idSnapshot] = await Promise.all([nameQuery, idQuery]);
                    const resultsMap = new Map();
                    nameSnapshot.docs.forEach(doc => resultsMap.set(doc.id, { id: doc.id, ...doc.data() }));
                    idSnapshot.docs.forEach(doc => resultsMap.set(doc.id, { id: doc.id, ...doc.data() }));
                    setSearchResults(Array.from(resultsMap.values()));
                } catch (error) {
                    console.error("Error searching students:", error);
                    setModalState({ isOpen: true, title: "검색 오류", content: "학생을 검색하는 중 오류가 발생했습니다." });
                } finally {
                    setIsSearching(false);
                }
            };

            const handleInviteClick = (studentToInvite) => {
                setModalState({
                    isOpen: true, isConfirm: true, title: "학급 초대 확인",
                    content: `'${studentToInvite.name}' 학생을 '${selectedClass.className}' 학급으로 초대하시겠습니까?`,
                    confirmText: "초대",
                    onConfirm: () => {
                        inviteStudent(studentToInvite, selectedClass.id);
                        setSearchResults(prev => prev.map(s => s.id === studentToInvite.id ? { ...s, classIds: [...(s.classIds || []), selectedClass.id] } : s));
                        return true;
                    }
                });
            };

            return (
                <div>
                    <InviteStudentModal isOpen={!!invitingStudent} onClose={() => setInvitingStudent(null)} student={invitingStudent} classes={classes} onInvite={inviteStudent} />
                    <h2 className="text-3xl font-bold mb-6 text-gray-800">☆  학생 관리</h2>
                    
                    {pendingStudents.length > 0 && (
                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-xl font-bold mb-4">가입 승인 대기</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left min-w-[600px]">
                                    <thead className="bg-gray-50"><tr><th className="p-3">이름</th><th className="p-3">학번</th><th className="p-3">학교 계정</th><th className="p-3 text-center">작업</th></tr></thead>
                                    <tbody>
                                        {pendingStudents.map(s => ( 
                                            <tr key={s.id} className="border-b">
                                                <td className="p-3">{s.name}</td>
                                                <td className="p-3">{s.studentId || '미지정'}</td>
                                                <td className="p-3">{s.schoolAccount}</td>
                                                <td className="p-3 text-center flex gap-2 justify-center">
                                                    <button onClick={() => rejectStudent(s.id)} className="btn-red !px-4 !py-1">거절</button>
                                                    <button onClick={() => approveStudent(s.id)} className="btn-sky !px-4 !py-1">승인</button>
                                                </td>
                                            </tr> 
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 className="text-xl font-bold mb-1">전체 학생 검색 및 초대</h3>
                        <p className="text-sm text-gray-500 mb-4">서비스에 가입된 전체 학생을 대상으로 검색하여, 해당 학급에 초대할 수 있습니다.</p>
                        <div className="flex flex-col md:flex-row gap-2 mb-4">
                            <input type="text" placeholder="학번 또는 이름으로 검색" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()} className="w-full p-2 border rounded-md"/>
                            <button onClick={handleSearch} disabled={isSearching} className="btn-sky !px-6 !py-2">{isSearching ? '검색 중...' : '검색'}</button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left min-w-[600px]"><thead className="bg-gray-50"><tr><th className="p-3">이름</th><th className="p-3">학번</th><th className="p-3">학교 계정</th><th className="p-3 text-center">초대</th></tr></thead>
                                <tbody>
                                    {isSearching ? (<tr><td colSpan="4" className="text-center text-gray-500 p-8">검색 중...</td></tr>) : searchResults.length > 0 ? searchResults.map(s => {
                                        const isAlreadyInClass = s.classIds?.includes(selectedClass.id);
                                        return (
                                            <tr key={s.id} className="border-b"><td className="p-3">{s.name}</td><td className="p-3">{s.studentId}</td><td className="p-3">{s.schoolAccount}</td>
                                                <td className="p-3 text-center"><button onClick={() => handleInviteClick(s)} disabled={isAlreadyInClass} className={isAlreadyInClass ? "btn-gray !px-4 !py-1" : "btn-green !px-4 !py-1"}>{isAlreadyInClass ? '초대됨' : '초대'}</button></td>
                                            </tr>);
                                    }) : (<tr><td colSpan="4" className="text-center text-gray-500 p-8">검색 결과가 없습니다.</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h3 className="text-xl font-bold mb-4">학급 학생 목록</h3>
                        <p className="text-sm text-gray-500 mb-4">현재 선택된 학급에 초대된 학생들의 명단입니다.</p>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left min-w-[600px]">
                                <thead className="bg-gray-50"><tr><th className="p-3">이름</th><th className="p-3">학번</th><th className="p-3">학교 계정</th><th className="p-3 text-center">작업</th></tr></thead>
                                <tbody>
                                    {students.map(s => ( 
                                        <tr key={s.id} className="border-b">
                                            <td className="p-3">{s.name}</td>
                                            <td className="p-3">{s.studentId}</td>
                                            <td className="p-3">{s.schoolAccount}</td>
                                            <td className="p-3 text-center flex gap-2 justify-center">
                                                <button onClick={() => setInvitingStudent(s)} className="btn-green !px-4 !py-1">학급 초대</button>
                                                <button onClick={() => deleteStudent(s)} className="btn-red !px-4 !py-1">학급에서 제외</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {students.length === 0 && <p className="text-center text-gray-500 py-8">소속된 학생이 없습니다.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const StudentScoreCard = ({ studentScore, headers }) => {
            if (!studentScore) return <div className="bg-white p-8 rounded-lg shadow-md text-center"><p className="text-gray-600">학생 점수 정보를 찾을 수 없습니다.</p></div>;
            const scoreHeaders = headers.filter(h => h && h !== '학번' && h !== '이름' && h !== '총점' && h !== '번호' && h !== 'studentId');
            const totalScoreHeader = headers.find(h => h === '총점');
            return (
                <div className="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <div className="border-b pb-4 mb-6 flex justify-between items-baseline">
                        <h3 className="text-2xl font-bold text-gray-800">{studentScore['이름']} <span className="text-lg font-medium text-gray-500">({studentScore['studentId']})</span></h3>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 mb-8">
                        {scoreHeaders.map(header => (
                            <div key={header} className="flex justify-between items-center border-b py-2">
                                <span className="text-gray-600">{header}</span>
                                <span className="font-mono text-lg font-semibold text-gray-800">{studentScore[header] ?? '-'} 점</span>
                            </div>
                        ))}
                    </div>
                    {totalScoreHeader && (
                        <div className="mt-8 pt-6 border-t-2 border-sky-500 flex justify-between items-center">
                            <span className="text-xl font-bold text-gray-800">{totalScoreHeader}</span>
                            <span className="font-mono text-3xl font-extrabold text-sky-600">{studentScore[totalScoreHeader] ?? '-'} 점</span>
                        </div>
                    )}
                </div>
            );
        };      

        const TestScoreViewer = ({ userData, isTeacher, selectedClass, setModalState, showToast }) => {
            const [scoresData, setScoresData] = useState({ headers: [], rows: [] });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [selectedStudentId, setSelectedStudentId] = useState('all');
            const [sheetUrl, setSheetUrl] = useState('');

            const extractSheetId = (url) => {
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            };

            const handleLinkSheet = async () => {
                const sheetId = extractSheetId(sheetUrl);
                if (!sheetId) {
                    setModalState({ isOpen: true, title: '오류', content: '유효한 Google Sheets URL을 입력해주세요.' });
                    return;
                }
                await db.collection('classes').doc(selectedClass.id).update({ googleSheetId: sheetId });
                showToast("Google 시트가 성공적으로 연동되었습니다.");
            };
            
            const handleUnlinkSheet = async () => {
                await db.collection('classes').doc(selectedClass.id).update({ googleSheetId: FieldValue.delete() });
                showToast("Google 시트 연동이 해제되었습니다.");
            }

            useEffect(() => {
                if (!selectedClass?.googleSheetId) {
                    setScoresData({ headers: [], rows: [] }); setLoading(false); setError(null); return;
                }
                
                const fetchSheetData = async () => {
                    setLoading(true); setError(null);
                    const SHEET_ID = selectedClass.googleSheetId;
                    const sheetName = selectedClass.className.replace(/[^0-9]/g, '');
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}&headers=1`;
                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('시트 정보를 불러올 수 없습니다. 공유 설정을 확인해주세요.');
                        const text = await res.text();
                        const jsonString = text.substring(47).slice(0, -2);
                        const json = JSON.parse(jsonString);
                        if (json.status === 'error' || !json.table || !json.table.cols || json.table.rows.length < 2) {
                            throw new Error(`시트 '${sheetName}'에 데이터가 없거나 형식이 올바르지 않습니다.`);
                        }
                        const headers = json.table.cols.map(col => col.label || col.id).filter(label => label);
                        const dataRows = json.table.rows.slice(1);
                        const rows = dataRows.map(row => {
                            const rowData = {};
                            if (row && row.c) {
                                row.c.forEach((cell, idx) => { if (headers[idx]) { rowData[headers[idx]] = cell ? cell.v : null; } });
                            }
                            const studentNum = rowData['번호']?.toString().padStart(2, '0');
                            if (studentNum) rowData['studentId'] = `${sheetName}${studentNum}`;
                            return rowData;
                        }).filter(row => row.studentId);
                        setScoresData({ headers, rows });
                    } catch(err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchSheetData();
            }, [selectedClass]);

            if (loading) return <div><h2 className="text-3xl font-bold mb-6 text-gray-800">☆  시험 점수</h2><div className="bg-white p-8 rounded-lg shadow-md text-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto"></div><p className="mt-4 text-gray-600">데이터를 불러오는 중입니다...</p></div></div>;
            
            if (isTeacher && !selectedClass.googleSheetId) {
                 return <div><h2 className="text-3xl font-bold mb-6 text-gray-800">☆  시험 점수</h2><div className="bg-white p-8 rounded-lg shadow-md"><h3 className="text-xl font-bold text-gray-700 mb-2">Google 시트 연동</h3><p className="text-gray-500 mb-4">이 학급의 시험 점수를 관리할 Google 시트의 URL을 입력해주세요.<br/><a href="https://docs.google.com/spreadsheets/d/1A4-3Df_UCruvAcZtavqHq8L5NvqZCBonQIb28t0wajw/edit?usp=sharing" target="_blank" rel="noopener noreferrer" className="text-sky-600 hover:underline font-bold text-sm">샘플 양식 시트 확인하기</a><span className="text-sm text-red-500">  * 시트는 <u>'링크가 있는 모든 사용자에게'</u> <b>뷰어</b>로 공유되어야 합니다. * '시험 점수' 기능 사용을 위해 정확한 <b>학급명</b>을 설정하세요. ('학년, 반' 숫자가 순서대로 들어가도록 설정) </span></p><div className="flex gap-2"><input type="text" value={sheetUrl} onChange={e => setSheetUrl(e.target.value)} className="w-full p-2 border rounded-md" placeholder="Google Sheets URL 붙여넣기" /><button onClick={handleLinkSheet} className="btn-sky !px-4 !py-2">연동</button></div></div></div>;
            }

            if (error) return <div><h2 className="text-3xl font-bold mb-6 text-gray-800">☆  시험 점수</h2><div className="bg-white p-8 rounded-lg shadow-md text-center text-red-500"><p>오류: {error}</p>{isTeacher && <button onClick={handleUnlinkSheet} className="btn-red !px-4 !py-2 mt-4">시트 연동 해제</button>}</div></div>;
            
            if (isTeacher) {
                const selectedStudentScore = selectedStudentId !== 'all' ? scoresData.rows.find(row => row.studentId === selectedStudentId) : null;
                return (
                    <div>
                        <div className="flex justify-between items-center mb-6"><h2 className="text-3xl font-bold text-gray-800">☆  시험 점수</h2><button onClick={handleUnlinkSheet} className="btn-gray !px-4 !py-2">시트 연동 해제</button></div>
                        <div className="mb-6 max-w-sm"><label htmlFor="student-score-select" className="block text-sm font-medium text-gray-700 mb-1">학생 선택</label><select id="student-score-select" className="w-full p-2 border border-gray-300 rounded-md shadow-sm" value={selectedStudentId} onChange={e => setSelectedStudentId(e.target.value)}><option value="all">전체 학생 표로 보기</option>{scoresData.rows.map(student => (<option key={student.studentId} value={student.studentId}>{student.이름} ({student.studentId})</option>))}</select></div>
                        {selectedStudentId === 'all' ? (
                            <div className="bg-white p-6 rounded-lg shadow-md overflow-x-auto"><table className="w-full text-left min-w-[800px]"><thead className="bg-gray-50"><tr>{scoresData.headers.map(header => (<th key={header} className="p-3 font-bold text-center">{header}</th>))}</tr></thead><tbody>{scoresData.rows.map((row, index) => (<tr key={index} className="border-b hover:bg-gray-50">{scoresData.headers.map(header => (<td key={header} className="p-3 font-mono text-center">{row[header]}</td>))}</tr>))}</tbody></table></div>
                        ) : (<StudentScoreCard studentScore={selectedStudentScore} headers={scoresData.headers} />)}
                    </div>
                );
            }
            
            const studentScore = scoresData.rows.find(row => row.studentId === userData.studentId);
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6 text-gray-800">☆  나의 시험 점수</h2>
                    {studentScore ? (<StudentScoreCard studentScore={studentScore} headers={scoresData.headers} />) : (<div className="bg-white p-8 rounded-lg shadow-md text-center"><p className="text-gray-600">아직 이 학급의 시험 점수가 등록되지 않았습니다.</p></div>)}
                </div>
            );
        };
        
        const StudentPerformanceCard = ({ headers, studentRecord }) => {
            if (!studentRecord) {
                return (
                    <div className="bg-white p-8 rounded-lg shadow-md text-center">
                        <p className="text-gray-600">아직 나의 수행평가 점수가 등록되지 않았습니다.</p>
                    </div>
                );
            }
            const validHeaders = Array.isArray(headers) ? headers : [];
            return (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <div className="border-b pb-4 mb-6">
                        <h3 className="text-2xl font-bold text-gray-800">{studentRecord.name} <span className="text-lg font-medium text-gray-500">({studentRecord.studentId})</span></h3>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[600px] border-collapse text-center">
                            <thead className="bg-gray-50">
                                <tr>{validHeaders.map((header, index) => (<th key={`name-${index}`} className="p-3 font-semibold border-b">{header.name}</th>))}</tr>
                            </thead>
                            <tbody>
                                <tr>{validHeaders.map((header, index) => (<td key={`perfect-score-${index}`} className="p-3 font-mono border-b text-sm text-gray-600">{header.perfectScore}</td>))}</tr>
                                <tr className="bg-rose-50">{validHeaders.map((header, index) => (<td key={`student-score-${index}`} className="p-3 font-bold text-2xl text-rose-600 font-mono">{(studentRecord.scores && typeof studentRecord.scores[index] !== 'undefined') ? studentRecord.scores[index] : '-'}</td>))}</tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };  

        const PerformanceScoreManager = ({ isTeacher, userData, selectedClass, setModalState, showToast }) => {
            const [assessmentData, setAssessmentData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedStudentId, setSelectedStudentId] = useState('all');
            const [grade, setGrade] = useState('');
            const [file, setFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (!selectedClass?.id) {
                    setAssessmentData(null); setLoading(false); return;
                }
                setLoading(true);
                const unsub = db.collection(CONSTANTS.COLLECTIONS.ASSESSMENTS).doc(selectedClass.id).onSnapshot(doc => {
                    if (doc.exists) { setAssessmentData(doc.data()); } else { setAssessmentData(null); }
                    setError(null); setLoading(false);
                }, err => { setError('데이터를 불러오는 중 오류가 발생했습니다.'); setLoading(false); });
                return () => unsub();
            }, [selectedClass?.id]);

            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (f && (f.name.endsWith('.xlsx') || f.name.endsWith('.xls'))) { setFile(f); } 
                else {
                    setModalState({ isOpen: true, title: '파일 형식 오류', content: '엑셀 파일(.xlsx, .xls)만 업로드할 수 있습니다.' });
                    setFile(null); if (fileInputRef.current) fileInputRef.current.value = "";
                }
            };

            const handleUpload = () => {
                if (!file) { setModalState({ isOpen: true, title: '파일 없음', content: '업로드할 엑셀 파일을 선택해주세요.' }); return; }
                if (!grade) { setModalState({ isOpen: true, title: '학년 미선택', content: '점수를 등록할 학년을 선택해주세요.' }); return; }
                setUploading(true);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                        if (jsonData.length < 4) throw new Error("엑셀 파일의 형식이 올바르지 않습니다. (최소 4줄 필요)");
                        
                        const headerRow = jsonData[0]; const perfectScoreRow = jsonData[1]; const studentDataRows = jsonData.slice(3);
                        const assessmentHeaders = []; const scoreColumnIndices = [];
                        headerRow.forEach((header, index) => {
                            if (index > 3 && header && header.toString().trim() !== "") {
                                assessmentHeaders.push({ name: header.toString(), perfectScore: perfectScoreRow[index]?.toString() || 'N/A' });
                                scoreColumnIndices.push(index);
                            }
                        });
                        const studentScores = studentDataRows.map(row => {
                            const classNum = row[1]?.toString(); const studentNum = row[2]?.toString(); const studentName = row[3]?.toString();
                            if (!classNum || !studentNum || !studentName) return null;
                            return { studentId: `${grade}${classNum}${studentNum.padStart(2, '0')}`, name: studentName, scores: scoreColumnIndices.map(colIndex => row[colIndex]?.toString() || '-') };
                        }).filter(Boolean);

                        const dataToSave = { grade, fileName: file.name, uploadedAt: new Date().toISOString(), headers: assessmentHeaders, scores: studentScores };
                        await db.collection(CONSTANTS.COLLECTIONS.ASSESSMENTS).doc(selectedClass.id).set(dataToSave);
                        setModalState({ isOpen: true, title: '업로드 성공', content: '수행평가 점수를 성공적으로 등록했습니다.' });
                        setFile(null); setGrade(''); if (fileInputRef.current) fileInputRef.current.value = "";
                    } catch (err) {
                        setModalState({ isOpen: true, title: '업로드 실패', content: `파일 처리 중 오류가 발생했습니다: ${err.message}` });
                    } finally { setUploading(false); }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleDelete = () => {
                setModalState({
                    isOpen: true, isConfirm: true, title: "점수 삭제 확인", content: `이 학급의 모든 수행평가 점수 데이터를 삭제하시겠습니까?`, confirmText: '삭제',
                    onConfirm: async () => { await db.collection(CONSTANTS.COLLECTIONS.ASSESSMENTS).doc(selectedClass.id).delete(); return true; }
                });
            };

            if (loading) return <div className="h-64 w-full skeleton"></div>;
            if (error) return <div className="bg-red-100 text-red-700 p-4 rounded-lg">{error}</div>;

            if (isTeacher) {
                const selectedStudentRecord = (assessmentData && selectedStudentId !== 'all') ? assessmentData.scores.find(s => s.studentId === selectedStudentId) : null;
                return (
                    <div>
                        <h2 className="text-3xl font-bold mb-6 text-gray-800">☆  수행 점수 관리</h2>
                        {!assessmentData ? (
                            <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                                <h3 className="text-xl font-bold mb-4">점수 파일 업로드</h3>
                                <span className="text-sm text-red-500">* <b>나이스</b> 상의 '수행평가 점수관리' 일괄등록 파일 양식(.xlsx) 업로드</span>
                                <div className="grid md:grid-cols-3 gap-4 items-end mt-2">
                                    <div className="w-full"><label className="text-sm font-medium text-gray-600">엑셀 파일</label><input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".xlsx, .xls" className="w-full mt-1 text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/></div>
                                    <div className="w-full"><label className="text-sm font-medium text-gray-600">학년 선택</label><select value={grade} onChange={e => setGrade(e.target.value)} className="w-full mt-1 p-2 border rounded-md"><option value="">-- 학년 --</option><option value="1">1학년</option><option value="2">2학년</option><option value="3">3학년</option></select></div>
                                    <button onClick={handleUpload} disabled={uploading} className="btn-sky w-full !py-2">{uploading ? '업로드 중...' : '업로드'}</button>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-xl font-bold mb-2">현재 등록된 점수 정보</h3>
                                            <p className="text-sm text-gray-500">파일: {assessmentData.fileName}</p>
                                            <p className="text-sm text-gray-500">업로드 일시: {new Date(assessmentData.uploadedAt).toLocaleString()}</p>
                                        </div>
                                        <button onClick={handleDelete} className="btn-red !px-4 !py-2">데이터 삭제</button>
                                    </div>
                                    <div className="max-w-sm"><label htmlFor="student-perf-select" className="block text-sm font-medium text-gray-700 mb-1">학생 선택</label><select id="student-perf-select" className="w-full p-2 border rounded-md" value={selectedStudentId} onChange={e => setSelectedStudentId(e.target.value)}><option value="all">전체 학생 표로 보기</option>{assessmentData.scores.map(student => (<option key={student.studentId} value={student.studentId}>{student.name} ({student.studentId})</option>))}</select></div>
                                </div>
                                {selectedStudentId !== 'all' && (selectedStudentRecord ? <StudentPerformanceCard headers={assessmentData.headers} studentRecord={selectedStudentRecord} /> : <div className="bg-white p-6 rounded-lg shadow-md"><p className="text-center text-gray-500">선택된 학생의 점수 정보를 불러올 수 없습니다.</p></div>)}
                            </div>
                        )}
                    </div>
                );
            }

            const studentRecord = assessmentData?.scores.find(s => s.studentId === userData.studentId);
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6 text-gray-800">☆  나의 수행 점수</h2>
                    {studentRecord ? <StudentPerformanceCard headers={assessmentData.headers} studentRecord={studentRecord} /> : <div className="bg-white p-8 rounded-lg shadow-md text-center"><p className="text-gray-600">아직 이 학급의 수행평가 점수가 등록되지 않았습니다.</p></div>}
                </div>
            );
        };

        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★★★★★       랜덤 팀 구성 컴포넌트 시작       ★★★★★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        const createTeamLayout = (_0x25a3d4,_0x42969f,_0x1f0e8a,_0x4f7f63)=>{var _0x573e04=["\x6D\x65\x6D\x62\x65\x72\x73","\x6C\x65\x6E\x67\x74\x68","\x72\x65\x64\x75\x63\x65","\x70\x75\x73\x68","\x69\x64","\x73\x6F\x72\x74","\x66\x6F\x72\x45\x61\x63\x68","\x66\x69\x6C\x74\x65\x72","\x68\x61\x73","\x75\x6E\x73\x68\x69\x66\x74","\x72\x61\x6E\x64\x6F\x6D","\x66\x72\x6F\x6D","\x66\x69\x6E\x64","\x73\x6F\x6D\x65"];const _0x1a8f9c=_0x25a3d4[_0x573e04[7]](_0x2c6a46=>_0x1f0e8a[_0x573e04[8]](_0x2c6a46[_0x573e04[4]])),_0x253b9a=_0x25a3d4[_0x573e04[7]](_0x33b934=>!_0x1f0e8a[_0x573e04[8]](_0x33b934[_0x573e04[4]])),_0x4b78c4=[..._0x253b9a][_0x573e04[5]](()=>Math[_0x573e04[10]]()-0.5),_0x15392e=Array[_0x573e04[11]]({length:_0x42969f},(_0x1b41c3,_0x4d16fe)=>({id:_0x4d16fe,members:[]}));return _0x1a8f9c[_0x573e04[6]](_0x3e4509=>{const _0x5bf5c0=_0x4f7f63[_0x573e04[12]](_0x2a3e0f=>_0x2a3e0f[_0x573e04[0]][_0x573e04[13]](_0x599f57=>_0x599f57[_0x573e04[4]]===_0x3e4509[_0x573e04[4]]));_0x5bf5c0&&_0x5bf5c0[_0x573e04[4]]<_0x42969f?_0x15392e[_0x5bf5c0[_0x573e04[4]]][_0x573e04[0]][_0x573e04[3]](_0x3e4509):_0x4b78c4[_0x573e04[9]](_0x3e4509)}),_0x4b78c4[_0x573e04[6]](_0x280e2f=>{const _0x597f8c=_0x15392e[_0x573e04[2]]((_0x26c04e,_0x247547)=>_0x26c04e[_0x573e04[0]][_0x573e04[1]]<=_0x247547[_0x573e04[0]][_0x573e04[1]]?_0x26c04e:_0x247547);_0x597f8c[_0x573e04[0]][_0x573e04[3]](_0x280e2f)}),_0x15392e[_0x573e04[6]](_0x303bb2=>_0x303bb2[_0x573e04[0]][_0x573e04[5]]((_0x111649,_0x3f9e8a)=>_0x111649.studentId - _0x3f9e8a.studentId)),_0x15392e};
            
        const createInitialTeamState = () => ({
            students: Array.from({ length: 28 }, (_, i) => ({ id: `manual-${i + 1}`, name: `학생 ${i + 1}`, studentId: i + 1 })),
            teams: [],
            teamCount: 6,
            fixedStudentIds: new Set(),
        });

        const teamReducer = (state, action) => {
            switch (action.type) {
                case 'LOAD_STATE': {
                    const { students = [], teams = [], teamCount, fixedStudentIds = [] } = action.payload;
                    const idMap = new Map();
                    const formattedStudents = students.map(s => {
                        const originalId = s.id;
                        const studentNumber = s.studentId !== undefined ? s.studentId : parseInt(String(originalId).replace('manual-', ''), 10);
                        const newInternalId = `manual-${studentNumber}`;
                        idMap.set(originalId, newInternalId);
                        return { ...s, id: newInternalId, studentId: studentNumber };
                    });
                    const formattedTeams = (teams || []).map(team => ({
                        ...team,
                        members: team.members.map(member => formattedStudents.find(s => s.id === idMap.get(member.id)) || member),
                    }));
                    const formattedFixedIds = new Set((Array.isArray(fixedStudentIds) ? fixedStudentIds : []).map(id => idMap.get(id)).filter(Boolean));
                    return { ...state, students: formattedStudents, teams: formattedTeams, teamCount: teamCount || state.teamCount, fixedStudentIds: formattedFixedIds };
                }
                case 'RESET_TO_MANUAL': return createInitialTeamState();
                case 'SET_TEAM_COUNT': return { ...state, teamCount: action.payload };
                case 'GENERATE_TEAMS': {
                    const { students, teamCount, fixedStudentIds, teams: oldTeams } = state;
                    if (students.length === 0 || teamCount < 1) return state;
                    const createTeamLayout_func = (_0x25a3d4,_0x42969f,_0x1f0e8a,_0x4f7f63)=>{var _0x573e04=["\x6D\x65\x6D\x62\x65\x72\x73","\x6C\x65\x6E\x67\x74\x68","\x72\x65\x64\x75\x63\x65","\x70\x75\x73\x68","\x69\x64","\x73\x6F\x72\x74","\x66\x6F\x72\x45\x61\x63\x68","\x66\x69\x6C\x74\x65\x72","\x68\x61\x73","\x75\x6E\x73\x68\x69\x66\x74","\x72\x61\x6E\x64\x6F\x6D","\x66\x72\x6F\x6D","\x66\x69\x6E\x64","\x73\x6F\x6D\x65"];const _0x1a8f9c=_0x25a3d4[_0x573e04[7]](_0x2c6a46=>_0x1f0e8a[_0x573e04[8]](_0x2c6a46[_0x573e04[4]])),_0x253b9a=_0x25a3d4[_0x573e04[7]](_0x33b934=>!_0x1f0e8a[_0x573e04[8]](_0x33b934[_0x573e04[4]])),_0x4b78c4=[..._0x253b9a][_0x573e04[5]](()=>Math[_0x573e04[10]]()-0.5),_0x15392e=Array[_0x573e04[11]]({length:_0x42969f},(_0x1b41c3,_0x4d16fe)=>({id:_0x4d16fe,members:[]}));return _0x1a8f9c[_0x573e04[6]](_0x3e4509=>{const _0x5bf5c0=_0x4f7f63[_0x573e04[12]](_0x2a3e0f=>_0x2a3e0f[_0x573e04[0]][_0x573e04[13]](_0x599f57=>_0x599f57[_0x573e04[4]]===_0x3e4509[_0x573e04[4]]));_0x5bf5c0&&_0x5bf5c0[_0x573e04[4]]<_0x42969f?_0x15392e[_0x5bf5c0[_0x573e04[4]]][_0x573e04[0]][_0x573e04[3]](_0x3e4509):_0x4b78c4[_0x573e04[9]](_0x3e4509)}),_0x4b78c4[_0x573e04[6]](_0x280e2f=>{const _0x597f8c=_0x15392e[_0x573e04[2]]((_0x26c04e,_0x247547)=>_0x26c04e[_0x573e04[0]][_0x573e04[1]]<=_0x247547[_0x573e04[0]][_0x573e04[1]]?_0x26c04e:_0x247547);_0x597f8c[_0x573e04[0]][_0x573e04[3]](_0x280e2f)}),_0x15392e[_0x573e04[6]](_0x303bb2=>_0x303bb2[_0x573e04[0]][_0x573e04[5]]((_0x111649,_0x3f9e8a)=>_0x111649.studentId - _0x3f9e8a.studentId)),_0x15392e};
                    const newTeams = createTeamLayout_func(students, teamCount, fixedStudentIds, oldTeams);
                    return { ...state, teams: newTeams };
                }
                case 'SORT_TEAMS': {
                    const sortedTeams = state.teams.map(team => ({...team, members: [...team.members].sort((a, b) => String(a.studentId).localeCompare(String(b.studentId)))}));
                    return { ...state, teams: sortedTeams };
                }
                case 'TOGGLE_FIXED_STUDENT': {
                    const studentId = action.payload;
                    const newFixedIds = new Set(state.fixedStudentIds);
                    newFixedIds.has(studentId) ? newFixedIds.delete(studentId) : newFixedIds.add(studentId);
                    return { ...state, fixedStudentIds: newFixedIds };
                }
                case 'SWAP_STUDENTS': {
                    const { studentAId, studentBId } = action.payload;
                    if (!studentAId || !studentBId || studentAId === studentBId) return state;
                    const newTeams = state.teams.map(team => ({ ...team, members: [...team.members] }));
                    let studentAInfo = null, studentBInfo = null;
                    newTeams.forEach(t => t.members.forEach((s, idx) => {
                        if (s.id === studentAId) studentAInfo = { student: s, team: t, index: idx };
                        if (s.id === studentBId) studentBInfo = { student: s, team: t, index: idx };
                    }));
                    if (studentAInfo && studentBInfo) {
                        studentAInfo.team.members[studentAInfo.index] = studentBInfo.student;
                        studentBInfo.team.members[studentBInfo.index] = studentAInfo.student;
                    }
                    return { ...state, teams: newTeams };
                }
                case 'UPDATE_STUDENT': {
                    const { id, field, value } = action.payload;
                    const updatedStudents = state.students.map(s => (s.id === id ? { ...s, [field]: value } : s));
                    return { ...state, students: updatedStudents };
                }
                case 'ADD_STUDENT': {
                    const existingIds = state.students.map(s => s.studentId);
                    let newStudentId = 1;
                    while(existingIds.includes(newStudentId)) { newStudentId++; }
                    return { ...state, students: [...state.students, { id: `manual-${newStudentId}`, studentId: newStudentId, name: "새 학생" }]};
                }
                case 'DELETE_STUDENT': {
                    const studentIdToDelete = action.payload;
                    const newFixedIds = new Set(state.fixedStudentIds);
                    newFixedIds.delete(studentIdToDelete);
                    return {
                        ...state,
                        students: state.students.filter(s => s.id !== studentIdToDelete),
                        teams: state.teams.map(team => ({ ...team, members: team.members.filter(s => s.id !== studentIdToDelete) })),
                        fixedStudentIds: newFixedIds
                    };
                }
                default: return state;
            }
        };
        
        const StudentTeamView = ({ selectedClass }) => {
            const [teamComposition, setTeamComposition] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!selectedClass?.id) {
                    setLoading(false);
                    return;
                }
                const unsub = db.collection('classes').doc(selectedClass.id).onSnapshot(doc => {
                    if (doc.exists && doc.data().teamComposition) {
                        setTeamComposition(doc.data().teamComposition);
                    } else {
                        setTeamComposition(null);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, [selectedClass]);

            if (loading) {
                return <div className="h-64 w-full skeleton"></div>;
            }

            if (!teamComposition || !teamComposition.teams || teamComposition.teams.length === 0) {
                return (
                    <div className="text-center text-gray-500 p-10 bg-white rounded-lg shadow-md">
                        <p className="text-xl font-bold">아직 선생님이 공유한 팀이 없습니다.</p>
                    </div>
                );
            }

            return (
                <div>
                    <h2 className="text-3xl font-bold text-gray-800 mb-6">📢 나의 팀 구성</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        {teamComposition.teams.map((team, index) => (
                            <div key={team.id} className="bg-white p-4 rounded-xl border shadow-md">
                                <h3 className="font-bold text-xl text-sky-700 mb-3 text-center pb-2 border-b">{index + 1}팀 ({team.members.length}명)</h3>
                                <ul className="space-y-2">
                                    {team.members.sort((a,b) => a.studentId - b.studentId).map(student => (
                                        <li key={student.id} className="text-center font-medium text-lg p-2 bg-slate-50 rounded-md">
                                            {(teamComposition.fixedStudentIds || []).includes(student.id) && '👑 '}{student.name}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const TeamBuilder = ({ propStudents, selectedClass, setModalState, showToast }) => {
            const [useClassData, setUseClassData] = useState(true);
            const [state, dispatch] = useReducer(teamReducer, undefined, createInitialTeamState);

            useEffect(() => {
                if (useClassData) {
                    if (propStudents && propStudents.length > 0) {
                        const formattedStudents = propStudents.map(s => ({ ...s, studentId: parseInt(s.studentId, 10) || 0 }));
                        dispatch({ type: 'LOAD_STATE', payload: { students: formattedStudents } });
                    }
                }
            }, [propStudents, useClassData]);

            useEffect(() => {
                if (!selectedClass?.id || !useClassData) return;

                const unsub = db.collection('classes').doc(selectedClass.id).onSnapshot(doc => {
                    if (doc.exists && doc.data().teamComposition) {
                        dispatch({ type: 'LOAD_STATE', payload: doc.data().teamComposition });
                    } else {
                        const formattedStudents = propStudents.map(s => ({ ...s, studentId: parseInt(s.studentId, 10) || 0 }));
                        dispatch({ type: 'LOAD_STATE', payload: { students: formattedStudents, teams: [], fixedStudentIds: [] } });
                    }
                });

                return () => unsub();
            }, [propStudents, selectedClass, useClassData]);

            const handleModeChange = (e) => {
                const isFileMode = e.target.checked;
                setUseClassData(!isFileMode);
                if (isFileMode) {
                    dispatch({ type: 'RESET_TO_MANUAL' });
                }
            };
            
            const handleGenerateTeams = () => {
                if (state.students.length === 0) { setModalState({isOpen: true, title: "알림", content: "학생이 없습니다. 명단을 추가하거나 파일을 불러와 주세요."}); return; }
                if (state.teamCount < 1) { setModalState({isOpen: true, title: "알림", content: "팀 개수는 1 이상이어야 합니다."}); return; }

                if (state.teams.length > 0) {
                    setModalState({ isOpen: true, isConfirm: true, title: "팀 다시 나누기", content: "팀을 다시 나누면 현재 팀 구성이 사라집니다 (팀 리더는 유지). 계속하시겠습니까?", onConfirm: () => { dispatch({ type: 'GENERATE_TEAMS' }); return true; } });
                } else {
                    dispatch({ type: 'GENERATE_TEAMS' });
                }
            };

            const handleSaveTeams = async () => {
                if (!selectedClass?.id) {
                    setModalState({ isOpen: true, title: "오류", content: "학급이 선택되지 않았습니다." });
                    return;
                }
                const dataToSave = {
                    students: state.students,
                    teams: state.teams,
                    teamCount: state.teamCount,
                    fixedStudentIds: Array.from(state.fixedStudentIds),
                    savedAt: new Date().toISOString(),
                };
                await db.collection('classes').doc(selectedClass.id).update({ teamComposition: dataToSave });
                setModalState({ isOpen: true, title: "성공", content: "현재 팀 구성이 저장되어 학생들에게 공유됩니다."});
            };

            const handleResetTeams = () => {
                 if (!selectedClass?.id) return;
                 setModalState({
                    isOpen: true,
                    isConfirm: true,
                    title: "⚠️ 저장된 결과 초기화",
                    content: (
                        <div className="text-center">
                            <p className="text-lg font-semibold text-gray-700">정말로 저장된 팀 구성을 삭제하시겠습니까?</p>
                            <p className="text-gray-500 mt-2"> 학생들에게 공유된 팀 정보가 모두 사라집니다.</p>
                        </div>
                    ),
                    confirmText: "삭제",
                    confirmButtonClass: 'btn-red',
                    onConfirm: async () => {
                        await db.collection('classes').doc(selectedClass.id).update({
                            teamComposition: FieldValue.delete()
                        });
                        dispatch({ type: 'LOAD_STATE', payload: { ...state, teams: [], fixedStudentIds: [] } });
                        return true;
                    }
                 });
            };

            const handleExcelDownload = () => {
                if (state.teams.length === 0) {
                    setModalState({ isOpen: true, title: "알림", content: "다운로드할 팀 구성이 없습니다." });
                    return;
                }
                const headers = state.teams.map((team, index) => `${index + 1}팀`);
                const maxTeamSize = Math.max(...state.teams.map(team => team.members.length));
                const dataRows = [];
                for (let i = 0; i < maxTeamSize; i++) {
                    const row = [];
                    state.teams.forEach(team => {
                        const member = team.members[i];
                        row.push(member ? `${member.studentId}. ${member.name}` : "");
                    });
                    dataRows.push(row);
                }
                const excelData = [headers, ...dataRows];
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "팀 배정 결과");
                XLSX.writeFile(workbook, "팀_배정_결과.xlsx");
            };

            const saveDataToFile = () => {
                try {
                    const dataToSave = { 
                        students: state.students, 
                        teams: state.teams, 
                        teamCount: state.teamCount, 
                        fixedStudentIds: Array.from(state.fixedStudentIds) 
                    };
                    const dataStr = JSON.stringify(dataToSave, null, 2);
                    const blob = new Blob([dataStr], {type: "text/plain;charset=utf-8"});
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = '팀구성_데이터.txt';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                } catch (error) { setModalState({isOpen: true, title: "오류", content: "데이터 저장에 실패했습니다."}); }
            };

            const loadDataFromFile = (event) => {
                const file = event.target.files[0];
                if (!file) { event.target.value = null; return; };
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (loadedData.students && Array.isArray(loadedData.students)) {
                            dispatch({ type: 'LOAD_STATE', payload: loadedData });
                        } else { setModalState({isOpen: true, title: "오류", content: "파일에 올바른 팀 구성 정보가 없습니다."}); }
                    } catch (error) { setModalState({isOpen: true, title: "오류", content: "파일을 읽는 데 실패했습니다. 올바른 데이터 파일인지 확인해 주세요."});
                    } finally { event.target.value = null; }
                };
                reader.readAsText(file);
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold text-gray-800">🎲 랜덤 팀 구성</h2>
                        <div className="flex items-center gap-3">
                            <span className={`text-sm font-semibold ${useClassData ? 'text-green-600' : 'text-gray-400'}`}>현재 학급 명단 사용</span>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" onChange={handleModeChange} checked={!useClassData} className="sr-only peer" />
                                <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                            <span className={`text-sm font-semibold ${!useClassData ? 'text-blue-600' : 'text-gray-400'}`}>파일/수동 관리</span>
                        </div>
                    </div>

                    <div className="text-sm text-gray-600 bg-slate-100 p-4 rounded-lg mb-6 border">
                        <p className="mb-1">• {useClassData ? "'현재 학급 명단'으로 팀을 구성합니다. (우측 상단 모드 변경 스위치)" : "'파일/수동 관리' 모드에서는 페이지 하단의 목록으로 팀을 구성합니다. (우측 상단 모드 변경 스위치)"}</p>
                        <p className="mb-1">• 팀 배정 완료 후에도, 각 팀원 이름 옆 드롭다운을 통해 다른 학생과 위치를 바꿀 수 있습니다.</p>
                        <p>• ☑️ 아이콘을 클릭하여 👑으로 바꾸면, 해당 학생을 팀에 고정한 채 나머지를 랜덤 배정합니다. (<b>팀 리더</b> 표시)</p>
                    </div>
                    
                    <div className="bg-white p-4 rounded-xl shadow-md mb-8">
                        <div className="flex flex-col sm:flex-row items-center justify-center gap-4 flex-wrap">
                            <div className="flex items-center gap-2">
                                <input type="number" value={state.teamCount} onChange={(e) => dispatch({ type: 'SET_TEAM_COUNT', payload: parseInt(e.target.value, 10) || 1 })} className="w-24 p-2 border border-gray-300 rounded-md text-center" min="1" />
                                <label className="font-semibold text-gray-700 whitespace-nowrap">개 팀으로 나누기</label>
                            </div>
                            <button onClick={handleGenerateTeams} className="btn-green w-full sm:w-auto">✨ 팀 나누기!</button>
                            {state.teams.length > 0 && <button onClick={() => dispatch({ type: 'SORT_TEAMS' })} className="btn-gray">번호순 재정렬</button>}
                            {state.teams.length > 0 && <button onClick={handleExcelDownload} className="btn-gray">엑셀 다운로드</button>}
                            {useClassData && state.teams.length > 0 && <button onClick={handleSaveTeams} className="btn-sky">결과 저장(학생 공유)</button>}
                            {useClassData && state.teams.length > 0 && <button onClick={handleResetTeams} className="btn-red">초기화</button>}
                        </div>
                    </div>

                    {state.teams.length > 0 && (
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                            {state.teams.map((team, index) => (
                                <div key={team.id} className="bg-slate-50 p-3 rounded-xl border border-slate-200 shadow-md">
                                    <h3 className="font-bold text-lg text-gray-700 mb-3 text-center pb-2 border-b border-slate-300">{index + 1}팀 ({team.members.length}명)</h3>
                                    <div className="space-y-2">
                                        {team.members.map(student => (
                                            <div key={student.id} className={`relative w-full border rounded-lg shadow-sm px-2 py-1 h-11 flex items-center gap-1 ${state.fixedStudentIds.has(student.id) ? 'bg-yellow-100 border-yellow-300' : 'bg-white border-gray-200'}`}>
                                                <button onClick={() => dispatch({type: 'TOGGLE_FIXED_STUDENT', payload: student.id })} title="팀원 고정/해제" className="flex-shrink-0 text-2xl">{state.fixedStudentIds.has(student.id) ? '👑' : '☑️'}</button>
                                                <div className="font-bold text-xs w-8 text-center">{student.studentId}.</div>
                                                <div className="flex-1 font-medium text-sm truncate">{student.name}</div>
                                                <div className="w-20 shrink-0">
                                                    <select onChange={(e) => dispatch({type: 'SWAP_STUDENTS', payload: { studentAId: student.id, studentBId: e.target.value }})} value="" className="w-full text-xs border border-gray-300 rounded-md">
                                                        <option value="">교환</option>
                                                        {state.students.filter(s => s.id !== student.id).sort((a,b) => a.studentId - b.studentId).map(s => (<option key={s.id} value={s.id}>{s.studentId}. {s.name}</option>))}
                                                    </select>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {!useClassData && 
                        <StudentListEditor
                            title="학생 명단 관리 (파일/수동 모드)"
                            students={state.students}
                            onUpdate={(id, field, value) => dispatch({ type: 'UPDATE_STUDENT', payload: { id, field, value } })}
                            onAdd={() => dispatch({ type: 'ADD_STUDENT' })}
                            onDelete={(studentId) => dispatch({ type: 'DELETE_STUDENT', payload: studentId })}
                            onLoad={loadDataFromFile}
                            onSave={saveDataToFile}
                            setModalState={setModalState}
                        />
                    }
                </div>
            );
        };
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★★★★★      랜덤 자리배치 컴포넌트 시작      ★★★★★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        const createInitialSeatingState = () => ({
            students: Array.from({ length: 28 }, (_, i) => ({ id: `manual-${i + 1}`, name: `학생 ${i + 1}`, studentId: i + 1 })),
            sections: { left: { name: '왼쪽', rows: 5, cols: 2 }, center: { name: '가운데', rows: 4, cols: 2 }, right: { name: '오른쪽', rows: 5, cols: 2 } },
            seatAssignments: {},
            fixedSeats: new Set(),
        });

        const seatingReducer = (state, action) => {
            switch (action.type) {
                case 'LOAD_DATA_FROM_FILE': {
                    const { students, sections, seatAssignments, fixedSeats } = action.payload;
                    const idMap = new Map();
                    const formattedStudents = students.map(s => {
                        const originalFileId = s.id;
                        const studentNumber = s.studentId !== undefined ? s.studentId : originalFileId;
                        const newInternalId = `manual-${studentNumber}`;
                        idMap.set(originalFileId, newInternalId);
                        return {
                            id: newInternalId,
                            name: s.name,
                            studentId: parseInt(studentNumber, 10),
                        };
                    });

                    const formattedAssignments = {};
                    if (seatAssignments) {
                        for (const seatId in seatAssignments) {
                            const originalStudentFileId = seatAssignments[seatId];
                            const newStudentInternalId = idMap.get(originalStudentFileId);
                            if (newStudentInternalId) {
                                formattedAssignments[seatId] = newStudentInternalId;
                            }
                        }
                    }
                    
                    return { 
                        ...state,
                        students: formattedStudents || [], 
                        sections: sections || state.sections, 
                        seatAssignments: formattedAssignments,
                        fixedSeats: new Set(fixedSeats || []) 
                    };
                }
                
                case 'LOAD_STUDENTS': {
                    const students = action.payload;
                    const newState = { ...createInitialSeatingState(), sections: state.sections, students };
                    const allSeatIds = [];
                    Object.entries(newState.sections).forEach(([key, { rows, cols }]) => {
                        for (let r = 0; r < rows; r++) {
                            for (let c = 0; c < cols; c++) {
                                allSeatIds.push(`${key.charAt(0).toUpperCase()}-${r + 1}-${c + 1}`);
                            }
                        }
                    });

                    const assignments = {};
                    allSeatIds.forEach((seatId, index) => {
                        if (students[index]) {
                            assignments[seatId] = students[index].id;
                        }
                    });

                    return { ...newState, seatAssignments: assignments };
                }

                case 'RESET_TO_MANUAL':
                    return createInitialSeatingState();
                
                case 'UPDATE_LAYOUT': {
                    const { sectionKey, dimension, value } = action.payload;
                    const numValue = Math.max(0, parseInt(value, 10) || 0);
                    const newSections = { ...state.sections, [sectionKey]: { ...state.sections[sectionKey], [dimension]: numValue } };
                    return { ...state, sections: newSections, seatAssignments: {}, fixedSeats: new Set() };
                }
                case 'RANDOMIZE_SEATS': {
                    const { allSeatIds, students } = action.payload;
                    
                    const fixedAssignments = {};
                    const fixedStudentIds = new Set();
                    state.fixedSeats.forEach(seatId => {
                        const studentIdInSeat = state.seatAssignments[seatId];
                        if (studentIdInSeat) {
                            fixedAssignments[seatId] = studentIdInSeat;
                            fixedStudentIds.add(studentIdInSeat);
                        }
                    });

                    const studentsToShuffle = students.filter(s => !fixedStudentIds.has(s.id));
                    const shuffledStudentIds = studentsToShuffle.map(s => s.id).sort(() => Math.random() - 0.5);
                    const seatsToFill = allSeatIds.filter(seatId => !state.fixedSeats.has(seatId));
                    
                    const newAssignments = { ...fixedAssignments };
                    seatsToFill.forEach((seatId, index) => {
                        if (shuffledStudentIds[index]) {
                            newAssignments[seatId] = shuffledStudentIds[index];
                        } else {
                            delete newAssignments[seatId]; // 학생 수보다 자리가 많을 경우 빈자리로 남김
                        }
                    });
                    
                    return { ...state, seatAssignments: newAssignments };
                }
                case 'SET_SEAT_ASSIGNMENT': {
                    const { seatId, studentIdStr } = action.payload;
                    const studentId = studentIdStr ? studentIdStr : null;
                    const newAssignments = { ...state.seatAssignments };
                    const oldStudentInTargetSeat = newAssignments[seatId];
                    const oldSeatOfNewStudent = Object.keys(newAssignments).find(key => newAssignments[key] === studentId);
                    
                    // 기존 정보 삭제
                    delete newAssignments[seatId];
                    if (oldSeatOfNewStudent) { delete newAssignments[oldSeatOfNewStudent]; }
                    
                    // 새 정보 할당 (교환 로직 포함)
                    if (studentId) {
                        newAssignments[seatId] = studentId;
                        if (oldStudentInTargetSeat && oldSeatOfNewStudent) {
                            newAssignments[oldSeatOfNewStudent] = oldStudentInTargetSeat;
                        }
                    }
                    
                    const newFixedSeats = new Set(state.fixedSeats);
                    if (!studentId) { newFixedSeats.delete(seatId); }
                    return { ...state, seatAssignments: newAssignments, fixedSeats: newFixedSeats };
                }
                case 'TOGGLE_FIX_SEAT': {
                    const {seatId, showModal} = action.payload;
                    const newFixedSeats = new Set(state.fixedSeats);
                    if (newFixedSeats.has(seatId)) { newFixedSeats.delete(seatId); } 
                    else {
                        if (state.seatAssignments[seatId]) { newFixedSeats.add(seatId); } 
                        else { showModal("학생이 배정되지 않은 좌석은 고정할 수 없습니다."); }
                    }
                    return { ...state, fixedSeats: newFixedSeats };
                }
                case 'UPDATE_STUDENT': {
                    const { id, field, value } = action.payload;
                    const updatedStudents = state.students.map(s => (s.id === id ? { ...s, [field]: value } : s));
                    return { ...state, students: updatedStudents };
                }
                case 'ADD_STUDENT': {
                    const existingIds = state.students.map(s => s.studentId);
                    let newStudentId = 1;
                    while(existingIds.includes(newStudentId)) { newStudentId++; }
                    return { ...state, students: [...state.students, { id: `manual-${newStudentId}`, studentId: newStudentId, name: "새 학생" }]};
                }
                case 'DELETE_STUDENT': {
                    const studentIdToDelete = action.payload;
                    const newAssignments = { ...state.seatAssignments };
                    const newFixedSeats = new Set(state.fixedSeats);
                    Object.keys(newAssignments).forEach(seatId => {
                        if (newAssignments[seatId] === studentIdToDelete) {
                            delete newAssignments[seatId];
                            newFixedSeats.delete(seatId);
                        }
                    });
                    return { ...state, students: state.students.filter(s => s.id !== studentIdToDelete), seatAssignments: newAssignments, fixedSeats: newFixedSeats };
                }
                default: return state;
            }
        };

        const SeatingChart = ({ propStudents, selectedClass, setModalState, showToast }) => {
            const [useClassData, setUseClassData] = useState(true);
            const [isScreenshotMode, setIsScreenshotMode] = useState(false);
            const [state, dispatch] = useReducer(seatingReducer, undefined, createInitialSeatingState);

            useEffect(() => {
                if (useClassData) {
                    const formattedStudents = (propStudents || []).map(s => ({
                        ...s,
                        studentId: parseInt(s.studentId, 10) || 0
                    }));
                    dispatch({ type: 'LOAD_STUDENTS', payload: formattedStudents });
                }
            }, [propStudents, useClassData]);

            const handleModeChange = (e) => {
                const isFileMode = e.target.checked;
                setUseClassData(!isFileMode);
                if (isFileMode) {
                    dispatch({ type: 'RESET_TO_MANUAL' });
                }
            };

            const allSeatIds = useMemo(() => {
                const ids = [];
                Object.entries(state.sections).forEach(([key, { rows, cols }]) => {
                    for (let r = 0; r < rows; r++) { for (let c = 0; c < cols; c++) { ids.push(`${key.charAt(0).toUpperCase()}-${r + 1}-${c + 1}`); } }
                });
                return ids;
            }, [state.sections]);

            const handleRandomize = () => {
                const studentCount = state.students.length;
                const seatCount = allSeatIds.length;
                
                if (studentCount > seatCount) {
                    setModalState({isOpen: true, title: "알림", content: `자리가 부족합니다! 학생 ${studentCount - seatCount}명이 앉을 자리가 없어요.`});
                    return;
                }
                dispatch({ type: 'RANDOMIZE_SEATS', payload: { allSeatIds, students: state.students } });
            };

            const handleSaveAsImage = () => {
                const element = document.getElementById('seatingChartArea');
                if (!element) return;
                setIsScreenshotMode(true);
                setTimeout(() => {
                    html2canvas(element, { backgroundColor: '#f3f4f6' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = '자리배치표.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        setIsScreenshotMode(false);
                    }).catch(error => {
                        console.error("이미지 저장 실패:", error);
                        setIsScreenshotMode(false);
                    });
                }, 100);
            };
            
            const saveDataToFile = () => {
                try {
                    const dataToSave = { students: state.students, sections: state.sections, seatAssignments: state.seatAssignments, fixedSeats: Array.from(state.fixedSeats) };
                    const dataStr = JSON.stringify(dataToSave, null, 2);
                    const blob = new Blob([dataStr], { type: "text/plain;charset=utf-8" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = '자리배치_데이터.txt';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                } catch (error) { setModalState({ isOpen: true, title: "오류", content: "데이터 저장에 실패했습니다." }); }
            };

            const loadDataFromFile = (event) => {
                const file = event.target.files[0];
                if (!file) { event.target.value = null; return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (loadedData.students && Array.isArray(loadedData.students)) {
                            dispatch({ type: 'LOAD_DATA_FROM_FILE', payload: loadedData });
                        } else { setModalState({ isOpen: true, title: "오류", content: "파일에 올바른 학생 명단 정보가 없습니다." }); }
                    } catch (error) { setModalState({ isOpen: true, title: "오류", content: "파일을 읽는 데 실패했습니다. 올바른 데이터 파일인지 확인해 주세요." });
                    } finally { event.target.value = null; }
                };
                reader.readAsText(file);
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold text-gray-800">🪄 랜덤 자리 배치</h2>
                        <div className="flex items-center gap-3">
                            <span className={`text-sm font-semibold ${useClassData ? 'text-green-600' : 'text-gray-400'}`}>현재 학급 명단 사용</span>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" onChange={handleModeChange} checked={!useClassData} className="sr-only peer" />
                                <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                            <span className={`text-sm font-semibold ${!useClassData ? 'text-blue-600' : 'text-gray-400'}`}>파일/수동 관리</span>
                        </div>
                    </div>

                    {/* --- 컨트롤 패널 영역 --- */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        {/* 배치 설정 */}
                        <div className="bg-white p-4 rounded-xl shadow-md lg:col-span-2">
                            <div className="grid grid-cols-3 gap-4">
                                {Object.entries(state.sections).map(([key, { name, rows, cols }]) => (
                                    <div key={key} className="text-center">
                                        <span className="font-bold text-base text-slate-700">{name}</span>
                                        <div className="flex items-center justify-center gap-x-3 gap-y-2 mt-2 flex-wrap">
                                            <div className="flex items-center gap-1">
                                                <label className="text-sm font-medium">행:</label>
                                                <input type="number" value={rows} onChange={(e) => dispatch({type: 'UPDATE_LAYOUT', payload: {sectionKey: key, dimension: 'rows', value: e.target.value}})} className="w-16 p-1 border rounded-md text-center"/>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <label className="text-sm font-medium">열:</label>
                                                <input type="number" value={cols} onChange={(e) => dispatch({type: 'UPDATE_LAYOUT', payload: {sectionKey: key, dimension: 'cols', value: e.target.value}})} className="w-16 p-1 border rounded-md text-center"/>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="text-center text-xs text-gray-500 mt-3 space-y-1">
                                <p>• 🔒자물쇠로 고정석 지정 가능.(홀수 빈 좌석에 활용) • 자리 섞기 완료 후에도, 좌석 별 드롭다운 버튼을 통해 두 학생 간 좌석 위치 교환 가능.</p>
                            </div>
                        </div>

                        {/* 실행 버튼 */}
                        <div className="bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center gap-4 lg:col-span-1">
                            <button onClick={handleRandomize} className="btn-green w-full">🪄 자리 섞기!</button>
                            <button onClick={handleSaveAsImage} className="btn-sky w-full">🖼️ 이미지로 저장</button>
                        </div>
                    </div>

                    {/* --- 자리 배치표 영역 --- */}
                    <main id="seatingChartArea" className="bg-white p-2 sm:p-4 rounded-xl shadow-md">
                        <div className="overflow-x-auto pb-2">
                            <div className="bg-white min-w-max mx-auto">
                                <div className="flex justify-center items-start gap-4 sm:gap-8 md:gap-12 p-4">
                                    {Object.entries(state.sections).map(([key, { name, rows, cols }]) => (
                                        <div key={key} className="flex flex-col items-center">
                                            <div className={`mb-2 text-base font-semibold text-gray-600 ${isScreenshotMode ? 'invisible' : ''}`}>{name}</div>
                                            <div className="grid gap-3" style={{ gridTemplateRows: `repeat(${rows}, 1fr)`, gridTemplateColumns: `repeat(${cols}, minmax(130px, 1fr))` }}>
                                                {Array.from({ length: rows * cols }).map((_, i) => {
                                                    const r = Math.floor(i / cols); const c = i % cols;
                                                    const seatId = `${key.charAt(0).toUpperCase()}-${r + 1}-${c + 1}`;
                                                    const student = state.students.find(s=>s.id === state.seatAssignments[seatId]);
                                                    return (<div key={seatId} className={`relative w-full h-24 border rounded-lg shadow-sm flex flex-col items-center justify-center transition-colors ${(state.fixedSeats.has(seatId) && !isScreenshotMode) ? 'bg-rose-200 border-rose-400' : 'bg-white'}`}>
                                                        {!isScreenshotMode && <div className="absolute top-1.5 left-2.5 text-xs text-gray-400 font-mono">{seatId}</div>}
                                                        {!isScreenshotMode && <button onClick={() => dispatch({type: 'TOGGLE_FIX_SEAT', payload: {seatId, showModal: (msg) => setModalState({isOpen: true, title: "알림", content: msg}) }})} title="고정/해제" className={`absolute top-1.5 right-1.5 w-6 h-6 rounded-full border transition-all ${state.fixedSeats.has(seatId) ? 'bg-rose-500 border-rose-700' : 'bg-gray-300 hover:bg-gray-400 border-gray-400'}`}><span className="text-white text-sm">{state.fixedSeats.has(seatId) ? '🔒' : '🔓'}</span></button>}
                                                        {student && <div className="text-gray-800 flex flex-col items-center justify-center text-center -mt-3"><div className="font-bold text-lg">{student.name}</div><div className="text-base text-gray-500">({student.studentId}번)</div></div>}
                                                        {!isScreenshotMode && <div className="absolute bottom-1.5 w-full px-2"><select value={state.seatAssignments[seatId] || ''} onChange={(e) => dispatch({type: 'SET_SEAT_ASSIGNMENT', payload: {seatId, studentIdStr: e.target.value }})} className="w-full text-sm border-gray-300 rounded p-1"><option value="">--</option>{state.students.sort((a,b) => a.studentId - b.studentId).map(s => (<option key={s.id} value={s.id}>{s.studentId}. {s.name}</option>))}</select></div>}
                                                    </div>);
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="w-full flex justify-center mt-2 pb-4"><h3 className="w-full max-w-md text-center font-bold text-xl p-2 bg-slate-200 text-slate-500 rounded-md">교탁</h3></div>
                            </div>
                        </div>
                    </main>
                    
                    {!useClassData &&
                        <StudentListEditor
                            title="학생 명단 관리 (파일/수동 모드)"
                            students={state.students}
                            onUpdate={(id, field, value) => dispatch({ type: 'UPDATE_STUDENT', payload: { id, field, value } })}
                            onAdd={() => dispatch({ type: 'ADD_STUDENT' })}
                            onDelete={(studentId) => dispatch({ type: 'DELETE_STUDENT', payload: studentId })}
                            onLoad={loadDataFromFile}
                            onSave={saveDataToFile}
                            setModalState={setModalState}
                        />
                    }
                </div>
            );
        };

        
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★★★★★                 컴포넌트 종료                 ★★★★★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        const Dashboard = ({ user, initialUserData, onLogout, showToast }) => {
            const [userData, setUserData] = useState(initialUserData);
            const [isSidebarExpanded, setIsSidebarExpanded] = useState(true);
            const [currentMenu, setCurrentMenu] = useState('schedule');
            const [classes, setClasses] = useState([]);
            const [selectedClassId, setSelectedClassId] = useState('');
            const [classData, setClassData] = useState({ students: [], pendingStudents: [] });
            const [loading, setLoading] = useState({ classes: true, classData: true });
            const [modalState, setModalState] = useState({ isOpen: false });
            const [isClassCodeVisible, setIsClassCodeVisible] = useState(true);
            
            const isTeacher = user.role === 'teacher';
            const isAdmin = user.email === CONSTANTS.ADMIN_ACCOUNT;
            const selectedClass = useMemo(() => classes.find(cls => cls.id === selectedClassId), [classes, selectedClassId]);

            useEffect(() => {
                if (!user?.uid) return;
                const collectionName = user.role === 'teacher' ? CONSTANTS.COLLECTIONS.TEACHERS : CONSTANTS.COLLECTIONS.STUDENTS;
                const unsub = db.collection(collectionName).doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) setUserData(doc.data());
                });
                return () => unsub();
            }, [user.uid, user.role]);

             useEffect(() => {
                let unsub = () => {};
                if (isTeacher) {
                    unsub = db.collection(CONSTANTS.COLLECTIONS.CLASSES)
                        .where('teacherId', '==', user.uid)
                        .onSnapshot(snapshot => {
                            const classList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            classList.sort((a, b) => a.className.localeCompare(b.className));
                            setClasses(classList);
                            if (classList.length > 0 && (!selectedClassId || !classList.some(c => c.id === selectedClassId))) {
                                setSelectedClassId(classList[0].id);
                            } else if (classList.length === 0) {
                                setSelectedClassId('');
                            }
                            setLoading(prev => ({ ...prev, classes: false }));
                        });
                } else {
                    const unsubStudent = db.collection('students').doc(user.uid).onSnapshot(async (studentDoc) => {
                        if (studentDoc.exists) {
                            const studentProfile = studentDoc.data();
                            const approvedClassIds = Object.keys(studentProfile.approvedBy || {}).filter(key => studentProfile.approvedBy[key]);
                            
                            if (approvedClassIds.length > 0) {
                                const classPromises = approvedClassIds.map(id => db.collection('classes').doc(id).get());
                                const classDocs = await Promise.all(classPromises);
                                let classList = classDocs.filter(doc => doc.exists).map(doc => ({ id: doc.id, ...doc.data() }));
                                classList.sort((a, b) => a.className.localeCompare(b.className));
                                setClasses(classList);
                                 if (classList.length > 0 && (!selectedClassId || !classList.some(c => c.id === selectedClassId))) {
                                      setSelectedClassId(classList[0].id);
                                 } else if (classList.length === 0) {
                                      setSelectedClassId('');
                                 }
                            } else {
                                setClasses([]);
                                setSelectedClassId('');
                            }
                        }
                        setLoading(prev => ({ ...prev, classes: false }));
                    });
                    return () => unsubStudent();
                }
                return () => unsub();
            }, [user.uid, isTeacher, selectedClassId]);
            
            useEffect(() => {
                if (!selectedClassId || !isTeacher) {  
                    setClassData({ students: [], pendingStudents: [] });
                    setLoading(prev => ({ ...prev, classData: false }));  
                    return;  
                }
                setLoading(prev => ({ ...prev, classData: true }));
                const studentsUnsub = db.collection(CONSTANTS.COLLECTIONS.STUDENTS).where('classIds', 'array-contains', selectedClassId).onSnapshot(snapshot => {
                    const allStudentsInClass = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setClassData({ 
                        students: allStudentsInClass.filter(s => s.approvedBy?.[selectedClassId]).sort((a, b) => String(a.studentId).localeCompare(String(b.studentId))), 
                        pendingStudents: allStudentsInClass.filter(s => !s.approvedBy?.[selectedClassId]).sort((a, b) => String(a.studentId).localeCompare(String(b.studentId)))
                    });
                    setLoading(prev => ({ ...prev, classData: false }));
                });
                return () => studentsUnsub();
            }, [selectedClassId, isTeacher]);

            const approveStudent = async (studentId) => {
                if (!selectedClassId) return;
                await db.collection('students').doc(studentId).update({ [`approvedBy.${selectedClassId}`]: true });
            };
            const rejectStudent = async (studentId) => {
                if (!selectedClassId) return;
                await db.collection('students').doc(studentId).update({ classIds: FieldValue.arrayRemove(selectedClassId), [`approvedBy.${selectedClassId}`]: FieldValue.delete() });
            };
            const deleteStudent = (studentToDelete) => {
                 setModalState({ isOpen: true, isConfirm: true, title: '학생 제외 확인', content: `'${studentToDelete.name}' 학생을 학급에서 제외하시겠습니까?`, onConfirm: async () => { await db.collection('students').doc(studentToDelete.id).update({ classIds: FieldValue.arrayRemove(selectedClassId), [`approvedBy.${selectedClassId}`]: FieldValue.delete() }); return true; } });
            };
            const inviteStudent = async (studentToInvite, targetClassId) => {
                 await db.collection('students').doc(studentToInvite.id).update({ classIds: FieldValue.arrayUnion(targetClassId), [`approvedBy.${targetClassId}`]: true });
            };
            const updateClass = async (classId, data) => {
                await db.collection('classes').doc(classId).update(data);
            };
            const deleteClass = (classItem) => { // classId 대신 classItem 객체 전체를 받도록 수정
                const classIdToDelete = classItem.id;
                setModalState({
                    isOpen: true, isConfirm: true, title: '학급 삭제 확인',
                    content: `'${classItem.className}' 학급을 정말로 삭제하시겠습니까? 학급에 속한 모든 학생 정보, 점수, 일정이 함께 삭제되며 복구할 수 없습니다.`,
                    confirmText: '삭제',
                    onConfirm: async () => {
                        try {
                            const studentsSnap = await db.collection('students').where('classIds', 'array-contains', classIdToDelete).get();
                            const studentBatch = db.batch();
                            studentsSnap.forEach(doc => {
                                studentBatch.update(doc.ref, { 
                                    classIds: FieldValue.arrayRemove(classIdToDelete), 
                                    [`approvedBy.${classIdToDelete}`]: FieldValue.delete() 
                                });
                            });
                            await studentBatch.commit();

                            await db.collection('schedules').doc(classIdToDelete).delete();
                            await db.collection('assessments').doc(classIdToDelete).delete();
                            await db.collection('scores').doc(classIdToDelete).delete().catch(e => console.log("Scores doc not found, skipping delete."));
                            await db.collection('classes').doc(classIdToDelete).delete();
                            
                            setModalState({ isOpen: true, title: "삭제 완료", content: "학급이 성공적으로 삭제되었습니다." });
                            return true;

                        } catch (error) {
                            console.error("학급 삭제 실패:", error);
                            setModalState({ isOpen: true, title: "삭제 실패", content: `학급 삭제 중 오류가 발생했습니다: ${error.message}` });
                            return false;
                        }
                    }
                });
            };

            const teacherMenuItems = [
                { id: 'schedule', label: '일정 관리', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> },
                { id: 'students', label: '학생 관리', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> },
                { id: 'scores', label: '수행 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg> },
                { id: 'test-scores', label: '시험 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> },
                { id: 'team-builder', label: '랜덤 팀 구성', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.002 3.002 0 012.288-2.542M11.644 16.143a3.003 3.003 0 011.712-2.542m0 0A3 3 0 0115 11.236V10c0-1.657-1.343-3-3-3S9 8.343 9 10v1.236A3 3 0 0111.644 16.143z" /></svg> },
                { id: 'seating-chart', label: '랜덤 자리배치', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 8v8m-3-5v5m-3-8v8M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z" /></svg> },
                { id: 'class', label: '학급 관리', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> },
            ];
            
            const studentMenuItems = [
                { id: 'schedule', label: '일정 확인', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> },
                { id: 'scores', label: '수행 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg> },
                { id: 'test-scores', label: '시험 점수', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> },
                { id: 'my-team', label: '나의 팀 구성', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.002 3.002 0 012.288-2.542M11.644 16.143a3.003 3.003 0 011.712-2.542m0 0A3 3 0 0115 11.236V10c0-1.657-1.343-3-3-3S9 8.343 9 10v1.236A3 3 0 0111.644 16.143z" /></svg> },
                { id: 'info', label: '내 정보', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> }
            ];

            const menuItems = isTeacher ? teacherMenuItems : studentMenuItems;
            const themeColor = isTeacher ? 'sky' : 'rose';
            
            const renderContent = () => {
                if(loading.classes || (isTeacher && loading.classData)) return <div className="h-full w-full skeleton"></div>;
                
                if(!selectedClassId && !['class', 'info', 'team-builder', 'seating-chart'].includes(currentMenu)) {
                    return <div className="text-center text-gray-500 p-10 bg-white rounded-lg shadow-md"><p className="text-xl font-bold">참여 중인 학급이 없습니다.</p><p className="mt-2">{isTeacher ? "'학급 관리' 메뉴에서 학급을 생성해주세요." : "아직 승인된 학급이 없습니다."}</p></div>;
                }

                switch (currentMenu) {
                    case 'schedule': 
                        return <ScheduleCalendar classes={classes} selectedClass={selectedClass} selectedClassId={selectedClassId} students={classData.students} teacherId={user.uid} isTeacher={isTeacher} setModalState={setModalState} showToast={showToast} />;
                    case 'students': 
                        return isTeacher ? <StudentManagement students={classData.students} pendingStudents={classData.pendingStudents} deleteStudent={deleteStudent} approveStudent={approveStudent} rejectStudent={rejectStudent} inviteStudent={inviteStudent} classes={classes} setModalState={setModalState} selectedClass={selectedClass} showToast={showToast} /> : null;
                    case 'scores': 
                        return <PerformanceScoreManager isTeacher={isTeacher} userData={userData} selectedClass={selectedClass} setModalState={setModalState} showToast={showToast} />;
                    case 'test-scores': 
                        return <TestScoreViewer isTeacher={isTeacher} userData={userData} selectedClass={selectedClass} setModalState={setModalState} showToast={showToast} />;
                    case 'team-builder': 
                        return isTeacher ? <TeamBuilder propStudents={classData.students} selectedClass={selectedClass} setModalState={setModalState} showToast={showToast} /> : null;
                    case 'seating-chart': 
                        return isTeacher ? <SeatingChart propStudents={classData.students} selectedClass={selectedClass} setModalState={setModalState} showToast={showToast} /> : null;
                    case 'class': 
                        return isTeacher ? <ClassManagement teacherId={user.uid} classes={classes} setModalState={setModalState} onUpdateClass={updateClass} onDeleteClass={deleteClass} isAdmin={isAdmin} showToast={showToast} /> : null;
                    case 'my-team': 
                        return <StudentTeamView selectedClass={selectedClass} />;
                    case 'info': 
                        return <UserInfo user={user} userData={userData} setModalState={setModalState} showToast={showToast} />;
                    default: 
                        return null;
                }
            };
            
            return (
                 <div className="flex h-screen bg-gray-100">
                    <Modal modalState={modalState} setModalState={setModalState} />
                    <aside className={`sidebar bg-white shadow-lg flex flex-col z-20 absolute md:relative inset-y-0 left-0 transform md:transform-none ${isSidebarExpanded ? "w-64" : "w-20"} ${isSidebarExpanded ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="flex flex-col flex-grow overflow-y-hidden">
                            <div className="flex-shrink-0 flex items-center justify-center p-2 border-b relative" style={{ minHeight: '60px' }}>
                                {isSidebarExpanded && <span className={`text-2xl font-bold text-${themeColor}-500`}>기가지현</span>}
                                <button onClick={() => setIsSidebarExpanded(!isSidebarExpanded)} className="p-2 rounded-lg hover:bg-gray-100 absolute top-3 right-3">{isSidebarExpanded ? <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg> }</button>
                            </div>
                            <div className="flex-grow overflow-y-auto p-2">
                                {isSidebarExpanded ? (
                                    <div>
                                        <p className="text-sm text-gray-500 mt-2 mb-4 text-center">{userData.name} {isTeacher ? '선생님' : '학생'}</p>
                                        {isTeacher && (
                                            <div className="my-4 mx-2">
                                                <div className="flex items-center justify-center mb-2 cursor-pointer" onClick={() => setIsClassCodeVisible(prev => !prev)}>
                                                    <label className="text-sm font-bold text-gray-600">현재 학급 코드</label>
                                                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 ml-1 text-gray-500 transition-transform ${isClassCodeVisible ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                                        <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                                                    </svg>
                                                </div>
                                                {isClassCodeVisible && (
                                                    // ★★★ 이 div에 onClick 이벤트와 스타일 수정을 적용합니다. ★★★
                                                    <div 
                                                        className="w-full bg-sky-100 text-sky-800 rounded-lg p-4 flex items-center justify-center h-24 cursor-pointer transition hover:bg-sky-200" 
                                                        onClick={() => {
                                                            if (selectedClass?.classCode) {
                                                                navigator.clipboard.writeText(selectedClass.classCode);
                                                                showToast("학급 코드가 복사되었습니다!");
                                                            }
                                                        }} 
                                                        title="클릭하여 복사"
                                                    >
                                                        {loading.classes ? (<div className="h-12 w-40 mx-auto skeleton"></div>) : (<p className="text-4xl font-black tracking-widest text-center">{selectedClass?.classCode || '----'}</p>)}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        <div className="my-4 px-2">
                                            <label htmlFor="class-select" className="text-sm font-bold text-gray-600 mb-2 block">학급 전환</label>
                                            <select id="class-select" className="w-full border rounded-lg p-2 bg-gray-50" value={selectedClassId} onChange={e => setSelectedClassId(e.target.value)} disabled={classes.length === 0}>
                                                {classes.length > 0 ? (classes.map(cls => <option key={cls.id} value={cls.id}>{cls.className}</option>)) : ( <option>참여 학급 없음</option> )}
                                            </select>
                                        </div>
                                    </div>
                                ) : (<div className="my-4 text-center"><p className={`text-xs font-bold text-gray-600 truncate p-2 bg-${themeColor}-100 rounded-md`}>{selectedClass?.className || 'N/A'}</p></div>)}
                                <nav className="space-y-1">{menuItems.map(item => (<button key={item.id} onClick={() => setCurrentMenu(item.id)} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors ${!isSidebarExpanded && 'justify-center'} ${currentMenu === item.id ? `bg-${themeColor}-500 text-white font-bold shadow` : `text-gray-600 hover:bg-gray-100`}`} title={isSidebarExpanded ? '' : item.label}>{item.icon}{isSidebarExpanded && <span>{item.label}</span>}</button>))} </nav>
                            </div>
                        </div>
                        <div className="p-2 border-t border-gray-200 flex-shrink-0">
                            <button onClick={onLogout} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-200 ${!isSidebarExpanded && 'justify-center'}`} title={isSidebarExpanded ? '' : "로그아웃"}><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>{isSidebarExpanded && <span>로그아웃</span>}</button>
                        </div>
                    </aside>
                    <div className="flex-1 flex flex-col">
                        <button onClick={() => setIsSidebarExpanded(true)} className="md:hidden p-2 bg-white/50 backdrop-blur-sm rounded-full shadow-md fixed top-4 left-4 z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                        <main className="flex-1 p-4 sm:p-8 overflow-y-auto">{renderContent()}</main>
                    </div>
                </div>
            );
        };

        // --- 메인 App 컴포넌트 ---
        function App() {
            const [user, setUser] = useState(undefined);
            const [userData, setUserData] = useState(null);
            const [view, setView] = useState('initial');
            const [error, setError] = useState('');
            const [modalState, setModalState] = useState({ isOpen: false });
            const { toast, showToast } = useToast(); // <-- 훅 호출


            useEffect(() => {
                const authUnsub = auth.onAuthStateChanged(async authUser => {
                    if (authUser) {
                        const teacherDoc = await db.collection(CONSTANTS.COLLECTIONS.TEACHERS).doc(authUser.uid).get();
                        if (teacherDoc.exists) {
                            setUser({ uid: authUser.uid, email: authUser.email, role: 'teacher' });
                            setUserData(teacherDoc.data()); return;
                        }
                        const studentDoc = await db.collection(CONSTANTS.COLLECTIONS.STUDENTS).doc(authUser.uid).get();
                        if (studentDoc.exists) {
                            setUser({ uid: authUser.uid, email: authUser.email, role: 'student' });
                            setUserData(studentDoc.data()); return;
                        }
                        auth.signOut();
                    } else {
                        setUser(null); setUserData(null); setView('initial');
                    }
                });
                return () => authUnsub();
            }, []);

            const handleGoogleLogin = async (role) => {
                setError('');
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                try {
                    const result = await auth.signInWithPopup(provider);
                    const gUser = result.user;
                    const email = gUser.email;

                    if (!email.endsWith(`@${CONSTANTS.SCHOOL_DOMAIN}`)) {
                        await auth.signOut();
                        setError(`'${CONSTANTS.SCHOOL_DOMAIN}' 학교 계정으로만 로그인이 가능합니다.`);
                        return;
                    }

                    const authorizedTeacherDoc = await db.collection(CONSTANTS.COLLECTIONS.AUTHORIZED_TEACHERS).doc(email).get();

                    if (role === 'teacher') {
                        if (!authorizedTeacherDoc.exists) {
                            await auth.signOut();
                            setError(`승인되지 않은 교사 계정입니다. 관리자에게 문의하세요.`);
                            return;
                        }
                    } else if (role === 'student') {
                        if (authorizedTeacherDoc.exists) {
                            await auth.signOut();
                            setError(`교사로 등록된 계정입니다. '교사'로 로그인해주세요.`);
                            return;
                        }
                    }
                    
                    const collectionName = role === 'teacher' ? 'teachers' : 'students';
                    const userRef = db.collection(collectionName).doc(gUser.uid);
                    const userDoc = await userRef.get();
                    if (!userDoc.exists) {
                        if (role === 'student') {
                            const displayName = gUser.displayName || '';
                            let studentId = ''; let name = displayName;
                            if (displayName && /^\d{4}/.test(displayName) && displayName.length > 4) {
                                studentId = displayName.substring(0, 4);
                                name = displayName.substring(5);
                            }
                            const newUserProfile = { name, schoolAccount: gUser.email, studentId, classIds: [], approvedBy: {} };
                            await userRef.set(newUserProfile);
                            setModalState({ isOpen: true, title: '첫 로그인', content: '계정이 생성되었습니다! 선생님이 학급에 초대하고 승인하면 서비스 이용이 가능합니다.' });
                        } else {
                            const newUserProfile = { name: gUser.displayName || '이름 없음', schoolAccount: gUser.email };
                            await userRef.set(newUserProfile);
                            setModalState({ isOpen: true, title: '환영합니다!', content: '교사 계정이 생성되었습니다. \'학급 관리\' 메뉴에서 첫 학급을 만들어주세요.' });
                        }
                    }
                } catch (err) {
                    setError(mapAuthCodeToMessage(err.code));
                }
            };

            if (user === undefined) return <div className="min-h-screen flex items-center justify-center text-xl">로딩 중...</div>;
            if (user && userData) { 
                return (
                    <>
                        <Toast message={toast.message} isVisible={toast.isVisible} />
                        <Dashboard 
                            user={user} 
                            initialUserData={userData} 
                            onLogout={() => auth.signOut()} 
                            showToast={showToast}
                        />
                    </>
                );
            }
            const InitialScreen = ({ onSelectRole }) => (
                <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-8 text-center">
                    <div className="space-y-4 mt-6">
                        <button onClick={() => onSelectRole('studentLogin')} className="w-full btn-rose py-3">학생</button>
                        <button onClick={() => onSelectRole('teacherLogin')} className="w-full btn-sky py-3">교사</button>
                    </div>
                </div>
            );

            const LoginScreen = ({ role, onLogin, onBack }) => {
                const isTeacher = role === 'teacher';
                return (
                    <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-8 text-center">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">{isTeacher ? '교사 로그인' : '학생 로그인'}</h2>
                        <button onClick={() => onLogin(role)} className="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <svg className="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,34.556,44,28.717,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                            Google 계정으로 로그인
                        </button>
                        <div className="text-sm text-center mt-6">
                            <a href="#" onClick={(e) => { e.preventDefault(); onBack(); }} className="font-medium text-gray-600">뒤로가기</a>
                        </div>
                    </div>
                );
            };

            let authView;
            switch(view) {
                case 'teacherLogin': authView = <LoginScreen role="teacher" onLogin={handleGoogleLogin} onBack={() => setView('initial')} />; break;
                case 'studentLogin': authView = <LoginScreen role="student" onLogin={handleGoogleLogin} onBack={() => setView('initial')} />; break;
                default: authView = <InitialScreen onSelectRole={setView} />;
            }
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-rose-100 to-sky-200 flex flex-col">
                    <main className="flex-grow flex flex-col justify-center items-center p-4">
                        <Toast message={toast.message} isVisible={toast.isVisible} />
                        <Modal modalState={modalState} setModalState={setModalState} />
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-bold text-slate-800">기가지현</h1>
                            <p className="text-slate-600 mt-2">스마트한 학급 운영의 시작</p>
                        </div>
                        {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4 w-full max-w-md cursor-pointer" onClick={() => setError('')}>{error}</div>}
                        <div className="w-full max-w-md">{authView}</div>
                    </main>
                    <footer className="text-center py-4"><p className="text-xs text-slate-500">© 2025. {CONSTANTS.ADMIN_ACCOUNT}</p></footer>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
